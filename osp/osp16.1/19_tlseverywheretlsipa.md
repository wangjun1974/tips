### 
https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/16.1/html/advanced_overcloud_customization/sect-tripleo-ipa

```
# 确认 /etc/resolv.conf 文件指向 ipa dns 
(undercloud) [stack@undercloud ~]$ cat /etc/resolv.conf 
# Generated by NetworkManager
search example.com
nameserver 192.168.122.3

# 安装所需软件 python3-ipalib python3-ipaclient 和 krb5-devel
(undercloud) [stack@undercloud ~]$ sudo dnf install -y python3-ipalib python3-ipaclient krb5-devel

# 如果重新安装了 ipa server 
# 记得从 ipa server 拷贝 /etc/ipa/ca.crt 文件
# 再把 ca.crt 拷贝到 /etc/pki/ca-trust/source/anchors/
# 最后执行 update-ca-trust extract 

# https://docs.openstack.org/project-deploy-guide/tripleo-docs/latest/features/tls-everywhere.html#tls-everywhere-with-tripleo-ipa

# 设置环境变量
(undercloud) [stack@undercloud ~]$ 
export IPA_USER=admin
export IPA_PASSWORD='redhat123'
export IPA_DOMAIN=example.com
export IPA_REALM=EXAMPLE.COM
export IPA_ADMIN_USER=$IPA_USER
export IPA_ADMIN_PASSWORD=$IPA_PASSWORD
export IPA_SERVER_HOSTNAME=helper.example.com
export UNDERCLOUD_FQDN=undercloud.example.com
export USER=stack
export CLOUD_DOMAIN=example.com

# (不确定是否一定要执行) 运行 playbook ipa-server-create-role.yaml
(undercloud) [stack@undercloud ~]$ kinit
(undercloud) [stack@undercloud ~]$ export IPA_PASSWORD=$IPA_PASSWORD
(undercloud) [stack@undercloud ~]$ export IPA_PRINCIPAL=$IPA_USER
(undercloud) [stack@undercloud ~]$ export UNDERCLOUD_FQDN=undercloud.example.com
(undercloud) [stack@undercloud ~]$ ansible-playbook /usr/share/ansible/tripleo-playbooks/ipa-server-create-role.yaml

# (不确定是否一定要执行) 运行 playbook ipa-server-register-undercloud.yaml
(undercloud) [stack@undercloud ~]$ export IPA_PASSWORD=$IPA_PASSWORD
(undercloud) [stack@undercloud ~]$ export IPA_PRINCIPAL=$IPA_USER
(undercloud) [stack@undercloud ~]$ export UNDERCLOUD_FQDN=undercloud.example.com
(undercloud) [stack@undercloud ~]$ ansible-playbook /usr/share/ansible/tripleo-playbooks/ipa-server-register-undercloud.yaml

# (不确定是否一定要执行) 运行 playbook ipa-server-create-principal.yaml
(undercloud) [stack@undercloud ~]$ export IPA_PASSWORD=$IPA_PASSWORD
(undercloud) [stack@undercloud ~]$ export IPA_PRINCIPAL=$IPA_USER
(undercloud) [stack@undercloud ~]$ export UNDERCLOUD_FQDN=undercloud.example.com
(undercloud) [stack@undercloud ~]$ ansible-playbook /usr/share/ansible/tripleo-playbooks/ipa-server-create-principal.yaml

# 运行 playbook undercloud-ipa-install.yaml
(undercloud) [stack@undercloud ~]$ ansible-playbook \
--ssh-extra-args "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
/usr/share/ansible/tripleo-playbooks/undercloud-ipa-install.yaml

# 编辑 undercloud.conf 文件，包含 overcloud_domain_name 和 undercloud_nameservers
# 不包含 enable_novajoin 和 ipa_otp 
# 根据与 Sadique 的建议 Ansible based TLS-E 不需要设置 ipa_otp 
# 找时间可以尝试一下
(undercloud) [stack@undercloud ~]$ sed -ie '/enable_novajoin/d ' undercloud.conf
(undercloud) [stack@undercloud ~]$ sed -ie '/ipa_otp/d ' undercloud.conf

(undercloud) [stack@undercloud ~]$ diff -urN undercloud.conf.novajoin undercloud.conf 
--- undercloud.conf.novajoin    2021-11-03 10:39:34.349105726 +0800
+++ undercloud.conf     2021-11-03 10:39:51.291105726 +0800
@@ -16,10 +16,8 @@
 enable_tempest = false
 enable_ui = false
 clean_nodes=true
-enable_novajoin = true
 overcloud_domain_name = example.com
 undercloud_nameservers = 192.168.122.3
-ipa_otp='8Ck&Ktu1xH1r7~m!N)0%|Z'
 
 
 [auth]

# 重新部署 undercloud
openstack undercloud install

# 生成所需 tls-parameters.yaml 模版
cat > ~/templates/tls-parameters.yaml <<EOF
resource_registry:
  OS::TripleO::Services::IpaClient: /usr/share/openstack-tripleo-heat-templates/deployment/ipa/ipaservices-baremetal-ansible.yaml
parameter_defaults:
  DnsSearchDomains: ["example.com"]
  DnsServers: ["192.168.122.3"]
  CloudDomain: example.com
  CloudName: overcloud.example.com
  CloudNameInternal: overcloud.internalapi.example.com
  CloudNameStorage: overcloud.storage.example.com
  CloudNameStorageManagement: overcloud.storagemgmt.example.com
  CloudNameCtlplane: overcloud.ctlplane.example.com
  IdMModifyDNS: True
  IdMServer: 192.168.122.3
  IdMDomain: example.com
  IdMInstallClientPackages: False
EOF


```

```
# 当遇到以下报错时
(undercloud) [stack@undercloud ~]$ sudo kinit -kt /etc/novajoin/krb5.keytab nova/undercloud.example.com@EXAMPLE.COM 
kinit: Preauthentication failed while getting initial credentials

# 检查 /etc/novajoin/krb5.keytab 文件，确认 stack 用户有这个文件的读取权限
https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/linux_domain_identity_authentication_and_policy_guide/retrieve-existing-keytabs
echo redhat123 | kinit admin
ipa-getkeytab -s helper.example.com -p nova/undercloud.example.com -k /etc/novajoin/krb5.keytab
klist
kdestroy
klist
kinit -kt /etc/novajoin/krb5.keytab nova/undercloud.example.com
klist
chmod a+r /etc/novajoin/krb5.keytab

# 安装过程中，在 ipa 服务器上可以检查服务的情况
ipa service-find | grep "Number of" 


"<13>Nov 18 03:00:07 puppet-user: Warning: Could not get certificate: Execution of '/usr/bin/getcert request -I libvirt-vnc-client-cert -f /etc/pki/libvirt-vnc/client-cert.pem -c IPA -N CN=overcloud-controller-0.internalapi.example.com -K libvirt-vnc/overcloud-controller-0.internalapi.example.com -D overcloud-controller-0.internalapi.example.com -C systemctl reload libvirtd -w -k /etc/pki/libvirt-vnc/client-key.pem -F /etc/pki/CA/certs/vnc.crt' returned 1: Path \"/etc/pki/CA/certs\": No such file or directory.",
"<13>Nov 18 03:00:08 puppet-user: Error: /Stage[main]/Tripleo::Profile::Base::Certmonger_user/Tripleo::Certmonger::Libvirt_vnc[libvirt-vnc-client-cert]/Certmonger_certificate[libvirt-vnc-client-cert]: Could not evaluate: The certificate 'libvirt-vnc-client-cert' wasn't found in the list.",

# tls-everywhere 需要
# 创建 /etc/pki/CA 目录
# 在 overcloud 节点上安装 openssl-perl 
# 查询提供者：sudo yum provides /etc/pki/CA
# 参考链接：https://bugs.launchpad.net/tripleo/+bug/1821139
(undercloud) [stack@undercloud ~]$ ansible -i /tmp/inventory all -f 6 -m yum -a 'name=openssl-perl* state=latest'
```

```
[1] How is TLS powered by certmonger being done
https://jaosorior.dev/2016/how-is-tls-powered-by-certmonger-being-done/

[2]
https://github.com/openstack/tripleo-heat-templates/blob/master/deployment/haproxy/haproxy-public-tls-certmonger.yaml

[3]
https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/13/html/advanced_overcloud_customization/converting_your_existing_deployment_to_use_tls
```