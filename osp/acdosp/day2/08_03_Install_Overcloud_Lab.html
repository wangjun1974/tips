<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="generator" content="Asciidoctor 0.1.4"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Deploy Overcloud with External Ceph, Service Telemetry Framework and Advanced configuration</title><style>@import url(http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.0/css/font-awesome.css);
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 100%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .mathblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #003b6b; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #00579e; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #333333; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: Arial, sans-serif; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Arial, sans-serif; font-weight: normal; font-style: normal; color: #7b2d00; text-rendering: optimizeLegibility; margin-top: 0.5em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #ff6b15; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; color: #003426; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; list-style-position: outside; font-family: Arial, sans-serif; }

ul, ol { margin-left: 1.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3em; font-weight: bold; }
dl dd { margin-bottom: 0.75em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: black; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 0.75em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #e15200; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #e15200; }

blockquote, blockquote p { line-height: 1.6; color: #333333; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
/* Print styles.  Inlined to avoid required HTTP connection: www.phpied.com/delay-loading-your-print-css/ Credit to Paul Irish and HTML5 Boilerplate (html5boilerplate.com)
*/
.print-only { display: none !important; }

@media print { * { background: transparent !important; color: #000 !important; /* Black prints faster: h5bp.com/s */ box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; /* h5bp.com/t */ }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #d8d8ce; }
/* Change -webkit-linear-gradient colors to  #a70000 and remove gradient */
table thead, table tfoot { background: -webkit-linear-gradient(top, #a70000, #a70000); font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: white; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #6d6e71; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #edf2f2; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

a:hover, a:focus { text-decoration: underline; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; padding: 3px 2px 1px 2px; white-space: nowrap; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; text-shadow: none; }

pre, pre > code { line-height: 1.6; color: black; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }

kbd.keyseq { color: #333333; }

kbd:not(.keyseq) { display: inline-block; color: black; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

kbd kbd:first-child { margin-left: 0; }

kbd kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: black; }

b.button:before { content: '[ '; }

b.button:after { content: ' ]'; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 1.5em; padding-right: 1.5em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#header { margin-bottom: 2.5em; }
#header > h1 { color: #7b2d00; font-weight: normal; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #333333; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }

#toc { border-bottom: 1px solid #dddddd; padding-bottom: 1.25em; }
#toc > ul { margin-left: 0.25em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }

#toctitle { color: #003b6b; }

@media only screen and (min-width: 768px) { body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: .90em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; border-width: 0; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }

#content #toctitle { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-size: 1em; padding-left: 0.125em; }

#footer { max-width: 100%; background-color: none; padding: 1.25em; }

#footer-text { color: black; line-height: 1.44; }

.sect1 { padding-bottom: 1.25em; }

.sect1 + .sect1 { border-top: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #7b2d00; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #622400; }

.imageblock, .literalblock, .listingblock, .mathblock, .verseblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .mathblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: left; font-weight: bold; }

.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #333333; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }

.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #aaaaaa; box-shadow: 0 1px 8px #aaaaaa; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #003b6b; margin-top: 0; line-height: 1.6; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre:not([class]), .listingblock pre:not([class]) { background: #eeeeee; }
.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border-width: 1px; border-style: dashed; border-color: #666666; -webkit-border-radius: 0; border-radius: 0; padding: 1.25em 1.5625em 1.125em 1.5625em; word-wrap: break-word; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock pre > code, .literalblock pre[class] > code, .listingblock pre > code, .listingblock pre[class] > code { display: block; }
@media only screen { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.72em; } }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.81em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.9em; } }

.listingblock pre.highlight { padding: 0; }
.listingblock pre.highlight > code { padding: 1.25em 1.5625em 1.125em 1.5625em; }

.listingblock > .content { position: relative; }

.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.375em; right: 0.375em; }

.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.sass:before { content: "sass"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }

table.pyhltable { border: 0; margin-bottom: 0; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }

.quoteblock { margin: 0 0 0.75em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 0.75em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: 0.8125em; color: #e15200; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }

table thead th, table tfoot th { font-weight: bold; }

table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 0; border-radius: 0; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }

table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }

table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }

table.tableblock td .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }

th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }

th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }

th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }

th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }

th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }

tbody tr th { display: table-cell; line-height: 1.4; background: -webkit-linear-gradient(top, #add386, #90b66a); }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: white; font-weight: bold; }

td > div.verse { white-space: pre; }

ol { margin-left: 1.75em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.375em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.375em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .8em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.qanda > ol > li > p > em:only-child { color: #004985; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }

.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #00579e; color: #004176; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum { display: inline-block; color: white !important; background-color: black; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { border-bottom: 1px solid #dddddd; }

#toctitle { color: #00406F; font-weight: normal; margin-top: 1.5em; }

.sidebarblock { border-color: #aaa; }

code { -webkit-border-radius: 4px; border-radius: 4px; }

p.tableblock.header { color: #6d6e71; }</style><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/3.2.0/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/sunburst.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script><script>hljs.initHighlightingOnLoad()</script></head><body class="article toc2 toc-left"><div id="header"><div id="toc" class="toc2"><div id="toctitle">Table of Contents</div><ul class="sectlevel1">
<li><a href="#_deploy_overcloud_with_external_ceph_service_telemetry_framework_and_advanced_configuration">Deploy Overcloud with External Ceph, Service Telemetry Framework and Advanced configuration</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_destroy_current_overcloud">Destroy current Overcloud</a></li>
<li><a href="#_configure_overcloud_for_integrations_and_advanced_configuration">Configure Overcloud for integrations and advanced configuration</a></li>
<li><a href="#_predictable_hostnames_and_ip_addresses">Predictable Hostnames and IP Addresses</a></li>
<li><a href="#_external_ceph_configuration">External Ceph Configuration</a></li>
<li><a href="#_service_telemetry_configuration">Service Telemetry Configuration</a></li>
<li><a href="#_overcloud_deployment">Overcloud Deployment</a></li>
</ul>
</li>
<li><a href="#_checking_the_overcloud">Checking the overcloud</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_checking_overall_deployment_and_predictable_values">Checking overall deployment and predictable values</a></li>
<li><a href="#_checking_ha_ceph">Checking HA &amp; Ceph</a></li>
</ul>
</li>
<li><a href="#_post_deployment_configuration">Post-Deployment Configuration</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_overcloud_networking">Overcloud Networking</a></li>
<li><a href="#_upload_the_cirros_image_to_overcloud">Upload the Cirros Image to Overcloud</a></li>
<li><a href="#_define_flavors_in_overcloud">Define Flavors in Overcloud</a></li>
<li><a href="#_create_a_tenant_in_overcloud">Create a Tenant in Overcloud</a></li>
<li><a href="#_set_tenant_networking_in_overcloud">Set Tenant Networking in Overcloud</a></li>
<li><a href="#_create_an_instance_in_overcloud">Create an Instance in Overcloud</a></li>
</ul>
</li>
<li><a href="#_service_telemetry_framework">Service Telemetry Framework</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_validating_the_installation">Validating the installation</a></li>
</ul>
</li>
<li><a href="#_fernet_keys">Fernet Keys</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_review_the_fernet_deployment">Review the Fernet Deployment</a></li>
<li><a href="#_rotate_the_fernet_keys">Rotate the Fernet keys</a></li>
</ul>
</li>
<li><a href="#_overcloud_validations">Overcloud Validations</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_run_an_overcloud_validation">Run an overcloud validation</a></li>
<li><a href="#_fencing_validation">Fencing validation</a></li>
<li><a href="#_fix_the_fencing_validation">Fix the fencing validation</a></li>
<li><a href="#_fix_the_failed_configuration_validation_only_as_an_example_strong_do_not_run_strong">Fix the failed configuration validation (ONLY AS AN EXAMPLE, <strong>DO NOT RUN</strong>)</a></li>
</ul>
</li>
<li><a href="#_outcome_of_this_lab">Outcome of This Lab</a></li>
</ul></div></div><div id="content"><div class="sect1"><h2 id="_deploy_overcloud_with_external_ceph_service_telemetry_framework_and_advanced_configuration">Deploy Overcloud with External Ceph, Service Telemetry Framework and Advanced configuration</h2><div class="sectionbody"><div class="sect2"><h3 id="_destroy_current_overcloud">Destroy current Overcloud</h3><div class="paragraph"><p>Previous deployment was using NFS as external storage for Glance and Cinder. In this module we installed Ceph and we will integrate on a new installation.</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Destroy the overcloud</p><div class="listingblock"><div class="content"><pre class="nowrap">[stack@undercloud ~]$ source ~/stackrc
(undercloud) [stack@undercloud ~]$ openstack overcloud delete overcloud --yes</pre></div></div>
<div class="listingblock"><div class="title">Expected Output</div><div class="content"><pre class="nowrap">Undeploying stack overcloud...
Waiting for messages on queue 'tripleo' with no timeout.
Deleting plan overcloud...
Success.</pre></div></div></li><li><p>Ensure the baremetal nodes are in available status</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ openstack baremetal node list</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+--------------------------------------+---------------------+---------------+-------------+--------------------+-------------+
| UUID                                 | Name                | Instance UUID | Power State | Provisioning State | Maintenance |
+--------------------------------------+---------------------+---------------+-------------+--------------------+-------------+
| 6a730e80-75ef-42fa-bfad-6c906c40a608 | overcloud-compute01 | None          | power off   | available          | False       |
| 44c0be67-14e7-4865-8af5-102314cd7cae | overcloud-compute02 | None          | power off   | available          | False       |
| 75f32a81-f6ef-40bf-82b5-a1c7b599d8b1 | overcloud-ctrl01    | None          | power off   | available          | False       |
| 9c6f04ab-920f-4b4c-bb06-6f04d3ca90b5 | overcloud-ctrl02    | None          | power off   | available          | False       |
| e88b78a7-b0b5-4376-9bc8-694d31c82df4 | overcloud-ctrl03    | None          | power off   | available          | False       |
| 8d009bf7-964a-4637-9b62-06c5254597c2 | overcloud-networker | None          | power off   | available          | False       |
| 0a40453f-86e4-440c-a620-4b8030ac6955 | overcloud-stor01    | None          | power off   | available          | False       |
+--------------------------------------+---------------------+---------------+-------------+--------------------+-------------+</pre></div></div></li></ol></div></div>
<div class="sect2"><h3 id="_configure_overcloud_for_integrations_and_advanced_configuration">Configure Overcloud for integrations and advanced configuration</h3></div>
<div class="sect2"><h3 id="_predictable_hostnames_and_ip_addresses">Predictable Hostnames and IP Addresses</h3><div class="paragraph"><p>You may have noticed that OSP director appears to "randomly" assign IP addresses to nodes from pools of IP addresses defined in <code>network-environment.yaml</code> (See the <code>AllocationPools</code> parameters) and the same goes for the VIPs. In addition, the hostnames that it associates to overcloud nodes follow a specific convention, i.e. <code>overcloud-role-X</code>.</p></div>
<div class="paragraph"><p>When it comes to production environments, you may want to have more control over the nodes' hostnames and the IP addresses that get allocated. In this section, you will see how to assign hostnames and IP addresses to the overcloud nodes.</p></div>
<div class="paragraph"><p>The host naming pattern is predefined by default with the <code>overcloud-role-X</code> convention, in order to specify you own hostnames you need to add an environment file which specifies the desired hostnames.</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Create an environment file that overrides the default hostnames:</p><div class="listingblock"><div class="content"><pre class="nowrap">[stack@undercloud config]$ cat &gt; ~/templates/HostnameMap.yaml &lt;&lt;EOF
parameter_defaults:
  HostnameMap:
    overcloud-controller-0: lab-controller01
    overcloud-controller-1: lab-controller02
    overcloud-controller-2: lab-controller03
    overcloud-novacompute-0: lab-compute01
    overcloud-novacompute-1: lab-compute02
EOF</pre></div></div>
<div class="paragraph"><p>As you can seen the default hostnames are mapped to customized hostnames. Like with any other environment file, you just need to include it at deployment time (i.e -e <code>templates/HostnameMap.yaml</code>). Once deployed you can check that the overcloud nodes have taken these names either by using <code>openstack server list</code> or by logging onto the machines over ssh.</p></div></li><li><p>Review the predefined pools:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ grep -e name: -e _pools ~/templates/network_data.yaml|grep -v ipv6</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">- name: Storage
  allocation_pools: [{'start': '172.18.0.4', 'end': '172.18.0.250'}]
- name: StorageMgmt
  allocation_pools: [{'start': '172.19.0.4', 'end': '172.19.0.250'}]
- name: InternalApi
  allocation_pools: [{'start': '172.17.0.4', 'end': '172.17.0.250'}]
- name: Tenant
  allocation_pools: [{'start': '172.16.0.4', 'end': '172.16.0.250'}]
- name: External
  allocation_pools: [{'start': '10.0.0.4', 'end': '10.0.0.250'}]
- name: Management
  allocation_pools: [{'start': '10.0.1.4', 'end': '10.0.1.250'}]</pre></div></div>
<div class="paragraph"><p>In the above, it shows that internal API IP addresses will be taken "randomly" from 172.17.0.4-172.17.0.250 range.</p></div>
<div class="paragraph"><p>Like you did for hostnames, you need to override the default configuration by adding an environment file. A default template is available in <code>/usr/share/openstack-tripleo-heat-templates/environments/ips-from-pool-all.yaml</code>.</p></div></li><li><p>Create a custom <code>ips-from-pool-all.yaml</code> file with IP addresses assigned to all overcloud nodes and VIP addresses:</p><div class="listingblock"><div class="content"><pre class="nowrap">[stack@undercloud ~]$ cat &gt; ~/templates/ips-from-pool-all.yaml &lt;&lt;EOF
parameter_defaults:
  ControllerIPs:
    # Each controller will get an IP from the lists below, first controller, first IP
    ctlplane:
    - 192.0.2.201
    - 192.0.2.202
    - 192.0.2.203
    external:
    - 10.0.0.201
    - 10.0.0.202
    - 10.0.0.203
    internal_api:
    - 172.17.0.201
    - 172.17.0.202
    - 172.17.0.203
    storage:
    - 172.18.0.201
    - 172.18.0.202
    - 172.18.0.203
    storage_mgmt:
    - 172.19.0.201
    - 172.19.0.202
    - 172.19.0.203
    tenant:
    - 172.16.0.201
    - 172.16.0.202
    - 172.16.0.203
    #management:
    #management:
    #- 172.16.4.251
  ComputeIPs:
    # Each compute will get an IP from the lists below, first compute, first IP
    ctlplane:
    - 192.0.2.211
    - 192.0.2.212
    external:
    - 10.0.0.211
    - 10.0.0.212
    internal_api:
    - 172.17.0.211
    - 172.17.0.212
    storage:
    - 172.18.0.211
    - 172.18.0.212
    storage_mgmt:
    - 172.19.0.211
    - 172.19.0.212
    tenant:
    - 172.16.0.211
    - 172.16.0.213
    #management:
    #- 172.16.4.252
### VIPs ###

  ControlFixedIPs: [{'ip_address':'192.0.2.150'}]
  InternalApiVirtualFixedIPs: [{'ip_address':'172.17.0.150'}]
  PublicVirtualFixedIPs: [{'ip_address':'10.0.0.150'}]
  StorageVirtualFixedIPs: [{'ip_address':'172.18.0.150'}]
  StorageMgmtVirtualFixedIPs: [{'ip_address':'172.19.0.150'}]
  RedisVirtualFixedIPs: [{'ip_address':'172.17.0.151'}]
EOF</pre></div></div>
<div class="paragraph"><p>The <code>parameter_defaults</code> is where the actual IP addresses are assigned. The role specific parameters (like <code>ControllerIPs</code>, <code>ComputeIPs</code>, etc.) are maps of network names (<code>external</code>, <code>internal_api</code>, etc.) to a list of addresses. Each network must have at least as many addresses as there are nodes on that network. The director assigns addresses in order. The first node of each role receives the first address on each respective list, the second node receives the second address on each respective lists, and so forth. The last section enforces VIP addresses.</p></div>
<div class="paragraph"><p>For reference, see the table below for the IP addresses allocated using the above environment file:</p></div>
<table class="tableblock frame-all grid-all" style="width:100%"><caption class="title">Table 1. Overcloud nodes</caption><colgroup><col style="width:20%"><col style="width:13%"><col style="width:13%"><col style="width:13%"><col style="width:13%"><col style="width:13%"><col style="width:13%"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Host</th><th class="tableblock halign-left valign-top">Ctl Plane</th><th class="tableblock halign-left valign-top">Internal API</th><th class="tableblock halign-left valign-top">Tenant</th><th class="tableblock halign-left valign-top">Storage</th><th class="tableblock halign-left valign-top">StorageMgmt</th><th class="tableblock halign-left valign-top">External</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Controller01</strong></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">192.0.2.201</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.17.0.201</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.16.0.201</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.18.0.201</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.19.0.201</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">10.0.0.201</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Controller02</strong></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">192.0.2.202</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.17.0.202</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.16.0.202</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.18.0.202</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.19.0.202</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">10.0.0.202</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Controller03</strong></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">192.0.2.203</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.17.0.203</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.16.0.203</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.18.0.203</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.19.0.203</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">10.0.0.203</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Compute01</strong></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">192.0.2.211</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.17.0.211</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.16.0.211</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.18.0.211</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.19.0.211</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">10.0.0.211</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Compute02</strong></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">192.0.2.212</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.17.0.212</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.16.0.212</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.18.0.212</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.19.0.212</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">10.0.0.212</p></td></tr></tbody></table>
<table class="tableblock frame-all grid-all" style="width:40%"><caption class="title">Table 2. VIP addresses</caption><colgroup><col style="width:57%"><col style="width:42%"></colgroup><thead><tr><th class="tableblock halign-left valign-top">VIP Name</th><th class="tableblock halign-left valign-top">IP</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ControlPlane</strong></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">192.0.2.150</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>InternalAPI VIP</strong></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.17.0.15</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Storage VIP</strong></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.18.0.150</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StorageMgmt VIP</strong></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.19.0.150</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ExternalAPI VIP</strong></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">10.0.0.150</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Redis VIP</strong></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">172.17.0.151</p></td></tr></tbody></table>
<div class="paragraph"><p>Once deployed you can check that VIP addresses are enforced with <code>openstack catalog list</code> as well as looking at the <code>OS_AUTH_URL</code> value in the generated <code>~/overcloudrc</code> file.</p></div></li></ol></div></div>
<div class="sect2"><h3 id="_external_ceph_configuration">External Ceph Configuration</h3><div class="olist arabic"><ol class="arabic"><li><p>Review the Ceph cluster state on the workstation (<code>192.0.2.249</code>):</p><div class="listingblock"><div class="content"><pre class="nowrap">[root@workstation ~]# ceph -s</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">  cluster:
    id:     9737db62-b1e9-4ce6-a866-66e858804ae7
    health: HEALTH_OK

  services:
    mon: 3 daemons, quorum ceph-node01,ceph-node02,ceph-node03
    mgr: ceph-node02(active), standbys: ceph-node01, ceph-node03
    osd: 6 osds: 6 up, 6 in

  data:
    pools:   0 pools, 0 pgs
    objects: 0  objects, 0 B
    usage:   644 MiB used, 53 GiB / 54 GiB avail
    pgs:</pre></div></div></li><li><p>Create a new Ceph user to be used for OpenStack integration:</p><div class="listingblock"><div class="content"><pre class="nowrap">[root@workstation ~]# ceph auth add client.openstack mon 'allow r' osd 'allow class-read object_prefix rbd_children, allow rwx pool=volumes, allow rwx pool=vms, allow rwx pool=images, allow rwx pool=backups, allow rwx pool=metrics'</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">added key for client.openstack</pre></div></div></li><li><p>Create the required Ceph pools:</p><div class="listingblock"><div class="content"><pre class="nowrap">[root@workstation ~]# for pool in volumes images vms backups metrics; do ceph osd pool create $pool 32; done</pre></div></div>
<div class="listingblock"><div class="title">Expected Output</div><div class="content"><pre class="nowrap">pool 'volumes' created
pool 'images' created
pool 'vms' created
pool 'backups' created
pool 'metrics' created</pre></div></div></li><li><p>Get the key for the <code>client.openstack</code>:</p><div class="listingblock"><div class="content"><pre class="nowrap">[root@workstation ~]# cephkey=$(sudo ceph auth get-key client.openstack)</pre></div></div></li><li><p>Get the <code>fsid</code> for the Ceph cluster_size:</p><div class="listingblock"><div class="content"><pre class="nowrap">[root@workstation ~]# fsid=$(grep fsid /etc/ceph/ceph.conf | awk '{print $3}')</pre></div></div></li><li><p>Create the <code>ceph-external.yaml</code> file to be used to configure overcloud to use the pre-installed Ceph storage cluster:</p><div class="listingblock"><div class="content"><pre class="nowrap">[root@workstation ~]# cat &gt; ceph-external.yaml &lt;&lt;EOF
parameter_defaults:
 CephClientKey: $cephkey
 CephClusterFSID: $fsid
 CephExternalMonHost: 172.18.0.61,172.18.0.62,172.18.0.63
EOF</pre></div></div></li><li><p>Review the created file:</p><div class="listingblock"><div class="content"><pre class="nowrap">[root@workstation ~]# cat ceph-external.yaml</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">parameter_defaults:
 CephClientKey: AQAiTeJehUqrIBAAvXiTZB9uRFH55L3bVht6Mw==
 CephClusterFSID: 798e8408-da52-4900-b8b7-808242429930
 CephExternalMonHost: 172.18.0.61,172.18.0.62,172.18.0.63</pre></div></div></li><li><p>Create the file ~/templates/ceph-external.yaml on undercloud with that content from hypervisor</p><div class="listingblock"><div class="content"><pre class="nowrap">[root@pool04-iad ~]# ssh 192.0.2.249 cat ceph-external.yaml | ssh stack@undercloud "tee templates/ceph-external.yaml"</pre></div></div></li><li><p>On Undercloud, review the content of the <code>/usr/share/openstack-tripleo-heat-templates/environments/ceph-ansible/ceph-ansible-external.yaml</code> template:</p><div class="listingblock"><div class="content"><pre class="nowrap">resource_registry:
  OS::TripleO::Services::CephExternal: ../../deployment/ceph-ansible/ceph-external.yaml

parameter_defaults:
  # NOTE: These example parameters are required when using CephExternal
  #CephClusterFSID: '4b5c8c0a-ff60-454b-a1b4-9747aa737d19'
  #CephClientKey: 'AQDLOh1VgEp6FRAAFzT7Zw+Y9V6JJExQAsRnRQ=='
  #CephExternalMonHost: '172.16.1.7, 172.16.1.8'

  # the following parameters enable Ceph backends for Cinder, Glance, Gnocchi and Nova
  NovaEnableRbdBackend: true
  CinderEnableRbdBackend: true
  CinderBackupBackend: ceph
  GlanceBackend: rbd
  # Uncomment below if enabling legacy telemetry
  # GnocchiBackend: rbd
  # If the Ceph pools which host VMs, Volumes and Images do not match these
  # names OR the client keyring to use is not named 'openstack',  edit the
  # following as needed.
  NovaRbdPoolName: vms
  CinderRbdPoolName: volumes
  CinderBackupRbdPoolName: backups
  GlanceRbdPoolName: images
  # Uncomment below if enabling legacy telemetry
  # GnocchiRbdPoolName: metrics
  CephClientUserName: openstack

  # finally we disable the Cinder LVM backend
  CinderEnableIscsiBackend: false</pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="icon-note" title="Note"></i></td><td class="content">Don&#8217;t modify this file. Only notice the name of the pools to be used and the client name.</td></tr></table></div></li></ol></div></div>
<div class="sect2"><h3 id="_service_telemetry_configuration">Service Telemetry Configuration</h3><div class="olist arabic"><ol class="arabic"><li><p>Create a file <code>/home/stack/templates/stf-connectors.yaml</code></p><div class="listingblock"><div class="title">Content</div><div class="content"><pre class="nowrap">parameter_defaults:
  CeilometerQdrPublishEvents: true
  MetricsQdrConnectors:
  - host: stf-default-interconnect-5671-service-telemetry.apps-crc.testing
    port: 443
    role: edge
    sslProfile: sslProfile
    verifyHostname: false</pre></div></div></li><li><p>Ensure you have connection to that endpoint</p><div class="listingblock"><div class="content"><pre class="nowrap">[stack@undercloud ~]$ curl -v stf-default-interconnect-5671-service-telemetry.apps-crc.testing:443</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">* Rebuilt URL to: stf-default-interconnect-5671-service-telemetry.apps-crc.testing:443/
*   Trying 192.168.130.11...
* TCP_NODELAY set
* Connected to stf-default-interconnect-5671-service-telemetry.apps-crc.testing (192.168.130.11) port 443 (#0)
&gt; GET / HTTP/1.1
&gt; Host: stf-default-interconnect-5671-service-telemetry.apps-crc.testing:443
&gt; User-Agent: curl/7.61.1
&gt; Accept: */*
&gt;
* Empty reply from server
* Connection #0 to host stf-default-interconnect-5671-service-telemetry.apps-crc.testing left intact
curl: (52) Empty reply from server</pre></div></div>
<div class="admonitionblock important"><table><tr><td class="icon"><i class="icon-important" title="Important"></i></td><td class="content">If this connection returns "Connection refused", run command <code>iptables -I FORWARD 1 -j ACCEPT</code> on the hypervisor.</td></tr></table></div></li></ol></div></div>
<div class="sect2"><h3 id="_overcloud_deployment">Overcloud Deployment</h3><div class="olist arabic"><ol class="arabic"><li><p>Create a script with the overcloud deployment command:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ cat &gt; ~/deploy-with-ext-ceph-stf.sh &lt;&lt;\EOF
#!/bin/bash
THT=/usr/share/openstack-tripleo-heat-templates/
CNF=~/templates/

source ~/stackrc
openstack overcloud deploy --templates $THT \
-r $CNF/roles_data.yaml \
-n $CNF/network_data.yaml \
-e $THT/environments/network-isolation.yaml \
-e $THT/environments/ceph-ansible/ceph-ansible-external.yaml \
-e $THT/environments/metrics/ceilometer-write-qdr.yaml \
-e $THT/environments/enable-stf.yaml \
-e $THT/environments/ips-from-pool-all.yaml \
-e $CNF/environments/network-environment.yaml \
-e $CNF/environments/net-bond-with-vlans.yaml \
-e ~/containers-prepare-parameter.yaml \
-e $CNF/node-info.yaml \
-e $CNF/ceph-external.yaml \
-e $CNF/HostnameMap.yaml \
-e $CNF/ips-from-pool-all.yaml \
-e $CNF/stf-connectors.yaml \
-e $CNF/fix-nova-reserved-host-memory.yaml
EOF
</pre></div></div></li><li><p>Deploy the overcloud:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ chmod 0755 ~/deploy-with-ext-ceph-stf.sh
(undercloud) [stack@undercloud ~]$ time ~/deploy-with-ext-ceph-stf.sh</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">&lt;&lt;OMITTED&gt;&gt;
Ansible passed.
Overcloud configuration completed.
Waiting for messages on queue 'tripleo' with no timeout.
Host 10.0.0.150 not found in /home/stack/.ssh/known_hosts
Overcloud Endpoint: http://10.0.0.150:5000
Overcloud Horizon Dashboard URL: http://10.0.0.150:80/dashboard
Overcloud rc file: /home/stack/overcloudrc
Overcloud Deployed

real	57m38.567s
user	0m13.965s
sys	0m1.338s
</pre></div></div>
<div class="paragraph"><p>Now that the cloud is deployed, you need to check its status and perform some post-deployment configuration to make it useful.</p></div></li></ol></div></div></div></div>
<div class="sect1"><h2 id="_checking_the_overcloud">Checking the overcloud</h2><div class="sectionbody"><div class="sect2"><h3 id="_checking_overall_deployment_and_predictable_values">Checking overall deployment and predictable values</h3><div class="paragraph"><p>Let&#8217;s check if the overcloud meets the parameters you set.</p></div>
<div class="paragraph"><p>Remember you should have :</p></div>
<div class="ulist"><ul><li><p>3 controllers (HA), 2 Compute nodes</p></li><li><p>Ceph backend for Nova, Glance and Cinder</p></li><li><p>Predictatable hostnames</p></li><li><p>Predicatable IP and VIP addresses</p></li><li><p>Service Telemetry Framework configured</p></li></ul></div>
<div class="paragraph"><p>When deploying an overcloud, director creates a Mistral plan with all parameters. The plan execution triggers the deployment.</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Check the stack environment with the following command:</p><div class="listingblock"><div class="content"><pre class="nowrap">[stack@undercloud ~]$ source ~/stackrc
(undercloud) [stack@undercloud ~]$ openstack stack environment show overcloud</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">parameters: {}
resource_registry:
  OS::Heat::SoftwareDeployment: https://192.0.2.2:13808/v1/AUTH_331932aba05f43759c8c3fae1f16ac9e/overcloud/config-download-software.yaml
  OS::Heat::StructuredDeployment: https://192.0.2.2:13808/v1/AUTH_331932aba05f43759c8c3fae1f16ac9e/overcloud/config-download-structured.yaml
  OS::TripleO::AllNodes::Validation: https://192.0.2.2:13808/v1/AUTH_331932aba05f43759c8c3fae1f16ac9e/overcloud/all-nodes-validation.yaml
  OS::TripleO::AllNodesDeployment: OS::Heat::None
  OS::TripleO::AllNodesExtraConfig: OS::Heat::None
  OS::TripleO::BlockStorage: https://192.0.2.2:13808/v1/AUTH_331932aba05f43759c8c3fae1f16ac9e/overcloud/puppet/blockstorage-role.yaml
  OS::TripleO::BlockStorage::Net::SoftwareConfig: https://192.0.2.2:13808/v1/AUTH_331932aba05f43759c8c3fae1f16ac9e/overcloud/user-files/home/stack/templates/network/config/bond-with-vlans/cinder-storage.yaml
  OS::TripleO::BlockStorage::NodeUserData: https://192.0.2.2:13808/v1/AUTH_331932aba05f43759c8c3fae1f16ac9e/overcloud/firstboot/userdata_default.yaml</pre></div></div>
<div class="paragraph"><p>This command shows you all environments variables, passwords that will be used as well as all custom parameters that have been set. It&#8217;s a good way to check if your modifications have been committed.</p></div></li><li><p>Check node&#8217;s assignments and predictable hostnames:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ openstack server list</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+--------------------------------------+-------------------------+--------+----------------------+----------------+---------+
| ID                                   | Name                    | Status | Networks             | Image          | Flavor  |
+--------------------------------------+-------------------------+--------+----------------------+----------------+---------+
| 6eba4ad0-22ee-4703-a3ef-11a37778acc3 | lab-controller03        | ACTIVE | ctlplane=192.0.2.203 | overcloud-full | control |
| f2690309-e176-4da0-8db9-73fe5aef8f19 | lab-controller01        | ACTIVE | ctlplane=192.0.2.201 | overcloud-full | control |
| a9723f20-8fe7-465f-9d70-cd83a56edfb5 | lab-controller02        | ACTIVE | ctlplane=192.0.2.202 | overcloud-full | control |
| 2bb0b7ed-818b-40a3-9391-73cb183899f6 | lab-compute02           | ACTIVE | ctlplane=192.0.2.212 | overcloud-full | compute |
| 98c31cfa-fbcd-4cc3-8c77-aea7fb2f655a | lab-compute01           | ACTIVE | ctlplane=192.0.2.211 | overcloud-full | compute |
+--------------------------------------+-------------------------+--------+----------------------+----------------+---------+</pre></div></div>
<div class="paragraph"><p>Notice IPs for the 3 controllers, 2 compute nodes. The naming convention has been enforced as well.</p></div></li><li><p>Check the isolated networks:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ openstack network list</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+--------------------------------------+--------------+--------------------------------------+
| ID                                   | Name         | Subnets                              |
+--------------------------------------+--------------+--------------------------------------+
| 120c98ed-3151-411b-a4e3-4caa615fafcd | storage_mgmt | df6226ea-da92-4940-a8bd-8140ee814803 |
| 4d281301-cba8-44f9-8c98-969902f75a51 | ctlplane     | f317af0a-3fc4-4d95-8e06-aaa7a8df5357 |
| 68ddaca1-b25c-4041-bb15-d43b8f253921 | storage      | 4ca2435d-97cd-4001-844a-df2d539def4f |
| 6fec1c30-19b4-4e9a-b845-aca6c797a166 | external     | f4691abf-7ce3-41e8-8520-52e7fcd95cd1 |
| 7d884216-db90-442c-b209-3181c25c1f7a | tenant       | 5c9ba555-38fc-45af-b639-970d60e7feeb |
| a196a2e0-302b-454d-8bf3-9977d16a76e6 | management   | 3aa27ee5-e940-4adf-8499-4e03a00cef1d |
| bb16c639-eb48-45fa-97bd-27053ea9b8bf | internal_api | 05aed8ba-fdb0-4f10-8364-c1d59d6d5ea4 |
+--------------------------------------+--------------+--------------------------------------+</pre></div></div></li><li><p>Check the subnets:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ openstack subnet list</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+--------------------------------------+---------------------+--------------------------------------+---------------+
| ID                                   | Name                | Network                              | Subnet        |
+--------------------------------------+---------------------+--------------------------------------+---------------+
| 05aed8ba-fdb0-4f10-8364-c1d59d6d5ea4 | internal_api_subnet | bb16c639-eb48-45fa-97bd-27053ea9b8bf | 172.17.0.0/24 |
| 3aa27ee5-e940-4adf-8499-4e03a00cef1d | management_subnet   | a196a2e0-302b-454d-8bf3-9977d16a76e6 | 10.0.1.0/24   |
| 4ca2435d-97cd-4001-844a-df2d539def4f | storage_subnet      | 68ddaca1-b25c-4041-bb15-d43b8f253921 | 172.18.0.0/24 |
| 5c9ba555-38fc-45af-b639-970d60e7feeb | tenant_subnet       | 7d884216-db90-442c-b209-3181c25c1f7a | 172.16.0.0/24 |
| df6226ea-da92-4940-a8bd-8140ee814803 | storage_mgmt_subnet | 120c98ed-3151-411b-a4e3-4caa615fafcd | 172.19.0.0/24 |
| f317af0a-3fc4-4d95-8e06-aaa7a8df5357 | ctlplane-subnet     | 4d281301-cba8-44f9-8c98-969902f75a51 | 192.0.2.0/24  |
| f4691abf-7ce3-41e8-8520-52e7fcd95cd1 | external_subnet     | 6fec1c30-19b4-4e9a-b845-aca6c797a166 | 10.0.0.0/24   |
+--------------------------------------+---------------------+--------------------------------------+---------------+</pre></div></div></li><li><p>Review assignment of the predictable IP and VIP addresses:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ openstack port list --device-owner " "</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+--------------------------------------+-------------------------+-------------------+-----------------------------------------------------------------------------+--------+
| ID                                   | Name                    | MAC Address       | Fixed IP Addresses                                                          | Status |
+--------------------------------------+-------------------------+-------------------+-----------------------------------------------------------------------------+--------+
| 3ffebdf4-d839-42a4-93d0-4cec51cf5a3d | storage_virtual_ip      | fa:16:3e:e6:5b:db | ip_address='172.18.0.150', subnet_id='4ca2435d-97cd-4001-844a-df2d539def4f' | DOWN   |
| 7470477d-6d5c-405d-937d-ef2f3208149e | storage_mgmt_virtual_ip | fa:16:3e:ee:62:d3 | ip_address='172.19.0.150', subnet_id='df6226ea-da92-4940-a8bd-8140ee814803' | DOWN   |
| 940220fe-dbcf-4c71-a18c-6a31829ed581 | ovn_dbs_virtual_ip      | fa:16:3e:c7:db:c4 | ip_address='172.17.0.14', subnet_id='05aed8ba-fdb0-4f10-8364-c1d59d6d5ea4'  | DOWN   |
| a54724f4-f89d-42d9-b14e-3872fdbc4a52 | public_virtual_ip       | fa:16:3e:b4:67:9d | ip_address='10.0.0.150', subnet_id='f4691abf-7ce3-41e8-8520-52e7fcd95cd1'   | DOWN   |
| d98de918-4d8e-4ce9-9bd9-fccbfe0cf0f2 | control_virtual_ip      | fa:16:3e:3c:95:16 | ip_address='192.0.2.150', subnet_id='f317af0a-3fc4-4d95-8e06-aaa7a8df5357'  | DOWN   |
| e7981554-2fa6-4986-8318-8d1fff9187ad | internal_api_virtual_ip | fa:16:3e:f5:66:b9 | ip_address='172.17.0.150', subnet_id='05aed8ba-fdb0-4f10-8364-c1d59d6d5ea4' | DOWN   |
| ff788c26-55d2-4c9d-b953-48754ea75f76 | redis_virtual_ip        | fa:16:3e:32:90:69 | ip_address='172.17.0.151', subnet_id='05aed8ba-fdb0-4f10-8364-c1d59d6d5ea4' | DOWN   |
+--------------------------------------+-------------------------+-------------------+-----------------------------------------------------------------------------+--------+</pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="icon-note" title="Note"></i></td><td class="content">Status <code>DOWN</code> is normal for the VIP addresses.</td></tr></table></div></li><li><p>Check also the authentication URL address:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ grep AUTH_URL ~/overcloudrc</pre></div></div>
<div class="listingblock"><div class="title">Expected Output</div><div class="content"><pre class="nowrap">export OS_AUTH_URL=http://10.0.0.150:5000</pre></div></div>
<div class="ulist"><ul><li><p>VIP actually matches the External Public API VIP as it was declared earlier.</p></li></ul></div></li><li><p>Verify that other VIP addresses match the deployment configuration:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ source ~/overcloudrc
(overcloud) [stack@undercloud ~]$ openstack catalog list</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+-----------+----------------+-------------------------------------------------------------------------------+
| Name      | Type           | Endpoints                                                                     |
+-----------+----------------+-------------------------------------------------------------------------------+
| keystone  | identity       | regionOne                                                                     |
|           |                |   admin: http://192.0.2.150:35357                                             |
|           |                | regionOne                                                                     |
|           |                |   internal: http://172.17.0.150:5000                                          |
|           |                | regionOne                                                                     |
|           |                |   public: http://10.0.0.150:5000                                              |
|           |                |                                                                               |
| heat      | orchestration  | regionOne                                                                     |
|           |                |   internal: http://172.17.0.150:8004/v1/f148ac5e621545beaf699127222940a6      |
|           |                | regionOne                                                                     |
|           |                |   public: http://10.0.0.150:8004/v1/f148ac5e621545beaf699127222940a6          |
|           |                | regionOne                                                                     |
|           |                |   admin: http://172.17.0.150:8004/v1/f148ac5e621545beaf699127222940a6         |
|           |                |                                                                               |
&lt;&lt;OMITTED&gt;&gt;</pre></div></div></li><li><p>Connect to the <code>lab-controller01</code> node:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ ssh heat-admin@lab-controller01.ctlplane</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">The authenticity of host '172.16.0.34 (172.16.0.34)' can't be established.
ECDSA key fingerprint is 16:37:9c:e9:38:d4:24:91:c6:bf:d5:5f:0f:c3:98:83.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '172.16.0.34' (ECDSA) to the list of known hosts.
[heat-admin@lab-controller01 ~]$</pre></div></div></li><li><p>Check that the node IP address assignments have been enforced:</p><div class="listingblock"><div class="title">[lab-controller01]</div><div class="content"><pre class="nowrap">[heat-admin@lab-controller01 ~]$ ip a | grep -e 172 -e 10.0.0</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">    inet 172.19.0.201/24 brd 172.19.0.255 scope global vlan40
    inet 10.0.0.201/24 brd 10.0.0.255 scope global vlan10
    inet 172.18.0.201/24 brd 172.18.0.255 scope global vlan30
    inet 172.16.0.201/24 brd 172.16.0.255 scope global vlan50
    inet 172.17.0.201/24 brd 172.17.0.255 scope global vlan20
    inet 172.17.0.150/32 brd 172.17.0.255 scope global vlan20
    inet 172.17.0.14/32 brd 172.17.0.255 scope global vlan20</pre></div></div>
<div class="paragraph"><p>Compare the IP addresses with the mapping and check that the IP addresses have been properly enforced.</p></div></li></ol></div></div>
<div class="sect2"><h3 id="_checking_ha_ceph">Checking HA &amp; Ceph</h3><div class="paragraph"><p>Let&#8217;s check if Pacemaker is running and all nodes are up:</p></div>
<div class="listingblock"><div class="content"><pre>[heat-admin@lab-controller01 ~]$ sudo pcs status cluster</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre>Cluster Status:
 Stack: corosync
 Current DC: lab-controller01 (version 2.0.2-3.el8_1.2-744a30d655) - partition with quorum
 Build Version: 1.6.7   :   Last updated: Fri Jun 12 09:32:01 2020
 Last change: Thu Jun 11 22:23:49 2020 by root via cibadmin on lab-controller01
 15 nodes configured
 47 resources configured

PCSD Status:
  lab-controller03: Online
  lab-controller02: Online
  lab-controller01: Online</pre></div></div>
<div class="paragraph"><p>More details on Pacemarker later on.</p></div>
<div class="paragraph"><p>Look at HAProxy configuration particularly the "listen" sections:</p></div>
<div class="listingblock"><div class="content"><pre>[heat-admin@lab-controller01 ~]$ sudo podman exec -ti haproxy-bundle-podman-0 cat /etc/haproxy/haproxy.cfg</pre></div></div>
<div class="paragraph"><p>HAproxy declares a listen section per service. For example, for <code>glance_api</code>:</p></div>
<div class="listingblock"><div class="content"><pre class="nowrap">[heat-admin@lab-controller01 ~]$ sudo podman exec -ti haproxy-bundle-podman-0 cat /etc/haproxy/haproxy.cfg | grep -A10 glance_api</pre></div></div>
<div class="listingblock"><div class="title">Extract from the file related to Glance</div><div class="content"><pre>listen glance_api
  bind 10.0.0.150:9292 transparent
  bind 172.17.0.150:9292 transparent
  mode http
  http-request set-header X-Forwarded-Proto https if { ssl_fc }
  http-request set-header X-Forwarded-Proto http if !{ ssl_fc }
  http-request set-header X-Forwarded-Port %[dst_port]
  option httpchk GET /healthcheck
  server lab-controller01.internalapi.localdomain 172.17.0.201:9292 check fall 5 inter 2000 rise 2
  server lab-controller02.internalapi.localdomain 172.17.0.202:9292 check fall 5 inter 2000 rise 2
  server lab-controller03.internalapi.localdomain 172.17.0.203:9292 check fall 5 inter 2000 rise 2</pre></div></div>
<div class="paragraph"><p>Here HAProxy declares two VIP addresses (<code>172.17.0.150</code> and <code>10.0.0.150</code>) balanced across three controllers via HTTP.</p></div>
<div class="paragraph"><p>Let&#8217;s now confirm that Ceph RBD is enabled in the OpenStack configuration files.</p></div>
<div class="paragraph"><p>Glance images:</p></div>
<div class="listingblock"><div class="title">[lab-controller01]</div><div class="content"><pre>[heat-admin@lab-controller01 ~]$ sudo podman exec -ti glance_api grep rbd /etc/glance/glance-api.conf | grep -v '#'</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre>enabled_backends=default_backend:rbd,http:http
[glance.store.rbd.store]
rbd_store_ceph_conf=/etc/ceph/ceph.conf
rbd_store_user=openstack
rbd_store_pool=images
[heat-admin@lab-controller0</pre></div></div>
<div class="paragraph"><p>Cinder volumes:</p></div>
<div class="listingblock"><div class="title">[lab-controller01]</div><div class="content"><pre>[heat-admin@lab-controller01 ~]$ sudo podman exec -ti cinder_api  grep rbd /etc/cinder/cinder.conf | grep -v '#'</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre>volume_driver=cinder.volume.drivers.rbd.RBDDriver
rbd_ceph_conf=/etc/ceph/ceph.conf
rbd_user=openstack
rbd_pool=volumes
rbd_flatten_volume_from_snapshot=False
rbd_secret_uuid=798e8408-da52-4900-b8b7-808242429930</pre></div></div>
<div class="paragraph"><p>You can also check Nova rbd configuration for ephemeral disks by running the same command on <code>/etc/nova/nova.conf</code> (on the compute node):</p></div>
<div class="listingblock"><div class="title">[lab-compute01]</div><div class="content"><pre>[heat-admin@lab-controller01 ~]$ logout
(undercloud) [stack@undercloud ~]$ ssh heat-admin@lab-compute01.ctlplane
[heat-admin@lab-compute01 ~]$ sudo podman exec -ti nova_compute  grep rbd /etc/nova/nova.conf | grep -v '#'</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre>images_type=rbd
images_rbd_pool=vms
images_rbd_ceph_conf=/etc/ceph/ceph.conf
rbd_user=openstack
rbd_secret_uuid=798e8408-da52-4900-b8b7-808242429930</pre></div></div></div></div></div>
<div class="sect1"><h2 id="_post_deployment_configuration">Post-Deployment Configuration</h2><div class="sectionbody"><div class="paragraph"><p>Now that we validated our overcloud, let&#8217;s make some post deployment configuration.</p></div>
<div class="sect2"><h3 id="_overcloud_networking">Overcloud Networking</h3><div class="olist arabic"><ol class="arabic"><li><p>Create a Neutron floating IP network:</p><div class="listingblock"><div class="content"><pre class="nowrap">[heat-admin@lab-compute01 ~]$ logout
(undercloud) [stack@undercloud ~]$ source ~/overcloudrc
(overcloud) [stack@undercloud ~]$ openstack network create public \
  --external --provider-physical-network datacentre \
  --provider-network-type vlan --provider-segment 10</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+---------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field                     | Value                                                                                                                                                            |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| admin_state_up            | UP                                                                                                                                                               |
| availability_zone_hints   |                                                                                                                                                                  |
| availability_zones        |                                                                                                                                                                  |
| created_at                | 2020-06-12T13:03:23Z                                                                                                                                             |
| description               |                                                                                                                                                                  |
| dns_domain                |                                                                                                                                                                  |
| id                        | 1ccc7a4e-4766-41a5-aff1-b0b949509a20                                                                                                                             |
| ipv4_address_scope        | None                                                                                                                                                             |
| ipv6_address_scope        | None                                                                                                                                                             |
| is_default                | False                                                                                                                                                            |
| is_vlan_transparent       | None                                                                                                                                                             |
| location                  | cloud='', project.domain_id=, project.domain_name='Default', project.id='d8e329a2859240ad953956d8cba7c230', project.name='admin', region_name='regionOne', zone= |
| mtu                       | 1500                                                                                                                                                             |
| name                      | public                                                                                                                                                           |
| port_security_enabled     | True                                                                                                                                                             |
| project_id                | d8e329a2859240ad953956d8cba7c230                                                                                                                                 |
| provider:network_type     | vlan                                                                                                                                                             |
| provider:physical_network | datacentre                                                                                                                                                       |
| provider:segmentation_id  | 10                                                                                                                                                               |
| qos_policy_id             | None                                                                                                                                                             |
| revision_number           | 1                                                                                                                                                                |
| router:external           | External                                                                                                                                                         |
| segments                  | None                                                                                                                                                             |
| shared                    | False                                                                                                                                                            |
| status                    | ACTIVE                                                                                                                                                           |
| subnets                   |                                                                                                                                                                  |
| tags                      |                                                                                                                                                                  |
| updated_at                | 2020-06-12T13:03:23Z                                                                                                                                             |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------+</pre></div></div>
<div class="paragraph"><p>You may be wondering where the <code>datacentre</code> physical network came from. This is a physical network name that is defined in the overcloud Neutron configuration files. It is mapped to a bridge name in <code>/etc/neutron/plugins/ml2/openvswitch_agent.ini</code> (inside neutron_api container):</p></div>
<div class="listingblock"><div class="content"><pre>bridge_mappings = datacentre:br-ex</pre></div></div>
<div class="paragraph"><p>This line indicates to Neutron that the external network exists on the physical network that is attached to <code>br-ex</code>, which is in turn determined by our NIC configuration files. This snippet from <code>templates/network/config/bond-with-vlans/compute.yaml</code> attaches <code>bond1</code> (an OVS bond of <code>eth1</code> and <code>eth2</code>) to <code>br-ex</code>. (<code>br-ex</code> is the default value of the <code>bridge_name</code> input parameter.):</p></div>
<div class="listingblock"><div class="content"><pre>              - type: ovs_bridge
                name: bridge_name

                dns_servers:
                  get_param: DnsServers
                members:
                - type: ovs_bond
                  name: bond1
                  ovs_options:
                    get_param: BondInterfaceOvsOptions
                  members:
                  - type: interface
                    name: nic2
                    primary: true
                  - type: interface
                    name: nic3</pre></div></div>
<div class="paragraph"><p>It is possible to create additional bridges in the NIC configuration files (and attach them to additional NICs/bonds). Physical network mappings can then be set with the <code>NeutronBridgeMappings</code> parameter.</p></div>
<div class="paragraph"><p>The external network also needs a subnet definition, but we need to be careful to ensure that the floating IP and virtual router IP range doesn&#8217;t overlap with the IP range used by the controllers and the public API VIP. That IP range is defined by the <code>ExternalAllocationPools</code> parameter in <code>templates/network_data.yaml</code>:</p></div>
<div class="listingblock"><div class="content"><pre>- name: External
  vip: true
  name_lower: external
  vlan: 10
  ip_subnet: '10.0.0.0/24'
  allocation_pools: [{'start': '10.0.0.4', 'end': '10.0.0.250'}]
  gateway_ip: '10.0.0.1'</pre></div></div></li><li><p>With that information, create the subnet:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud) [stack@undercloud ~]$ openstack subnet create public-subnet \
  --no-dhcp --network public --subnet-range 10.0.0.0/24 \
  --allocation-pool start=10.0.0.100,end=10.0.0.200  \
  --gateway 10.0.0.1 --dns-nameserver 8.8.8.8</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+-------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field             | Value                                                                                                                                                            |
+-------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| allocation_pools  | 10.0.0.100-10.0.0.200                                                                                                                                            |
| cidr              | 10.0.0.0/24                                                                                                                                                      |
| created_at        | 2020-06-12T13:05:41Z                                                                                                                                             |
| description       |                                                                                                                                                                  |
| dns_nameservers   | 8.8.8.8                                                                                                                                                          |
| enable_dhcp       | False                                                                                                                                                            |
| gateway_ip        | 10.0.0.1                                                                                                                                                         |
| host_routes       |                                                                                                                                                                  |
| id                | 533cbe43-1b7b-44d6-bac1-b16d6f46f9ef                                                                                                                             |
| ip_version        | 4                                                                                                                                                                |
| ipv6_address_mode | None                                                                                                                                                             |
| ipv6_ra_mode      | None                                                                                                                                                             |
| location          | cloud='', project.domain_id=, project.domain_name='Default', project.id='d8e329a2859240ad953956d8cba7c230', project.name='admin', region_name='regionOne', zone= |
| name              | public-subnet                                                                                                                                                    |
| network_id        | 1ccc7a4e-4766-41a5-aff1-b0b949509a20                                                                                                                             |
| prefix_length     | None                                                                                                                                                             |
| project_id        | d8e329a2859240ad953956d8cba7c230                                                                                                                                 |
| revision_number   | 0                                                                                                                                                                |
| segment_id        | None                                                                                                                                                             |
| service_types     |                                                                                                                                                                  |
| subnetpool_id     | None                                                                                                                                                             |
| tags              |                                                                                                                                                                  |
| updated_at        | 2020-06-12T13:05:41Z                                                                                                                                             |
+-------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------+</pre></div></div></li></ol></div></div>
<div class="sect2"><h3 id="_upload_the_cirros_image_to_overcloud">Upload the Cirros Image to Overcloud</h3><div class="admonitionblock important"><table><tr><td class="icon"><i class="icon-important" title="Important"></i></td><td class="content">It is always better to upload raw images if Ceph is used as a backend for Glance. Otherwise, if one uploads e.g. qcow2 or vmdk formatted images a conversion will take place from the source image format to raw while booting the instance. For doing the conversion, Nova downloads the image to compute /var/lib/nova/instances/_base which overall slows down the boot process. This conversion process may also become a source of problems if the conversion fails or never finishes.</td></tr></table></div>
<div class="olist arabic"><ol class="arabic"><li><p>Convert the image to a raw format:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud) [stack@undercloud ~]$ qemu-img convert -f qcow2 -O raw cirros-0.4.0-x86_64-disk.img cirros-0.4.0-x86_64-disk.raw</pre></div></div></li><li><p>Upload the image to the Glance image store (by default, the command uses the <code>raw</code> disk format and <code>bare</code> container format):</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud) [stack@undercloud ~]$ openstack image create cirros --public --file cirros-0.4.0-x86_64-disk.raw</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field            | Value                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
+------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| checksum         | ba3cd24377dde5dfdd58728894004abb                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| container_format | bare                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| created_at       | 2020-06-13T12:57:59Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| disk_format      | raw                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| file             | /v2/images/bd66c2ea-55d5-4463-9d33-779812aae2d9/file                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| id               | bd66c2ea-55d5-4463-9d33-779812aae2d9                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| min_disk         | 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| min_ram          | 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| name             | cirros                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| owner            | d8e329a2859240ad953956d8cba7c230                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| properties       | direct_url='rbd://798e8408-da52-4900-b8b7-808242429930/images/bd66c2ea-55d5-4463-9d33-779812aae2d9/snap', locations='[{'url': 'rbd://798e8408-da52-4900-b8b7-808242429930/images/bd66c2ea-55d5-4463-9d33-779812aae2d9/snap', 'metadata': {'store': 'default_backend'}}]', os_hash_algo='sha512', os_hash_value='b795f047a1b10ba0b7c95b43b2a481a59289dc4cf2e49845e60b194a911819d3ada03767bbba4143b44c93fd7f66c96c5a621e28dff51d1196dae64974ce240e', os_hidden='False', stores='default_backend' |
| protected        | False                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| schema           | /v2/schemas/image                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| size             | 46137344                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| status           | active                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| tags             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| updated_at       | 2020-06-13T12:58:14Z                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| virtual_size     | None                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| visibility       | public                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
+------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</pre></div></div></li><li><p>Check Ceph pools (on the workstation) and verify that the image has been effectively uploaded to Ceph:</p><div class="listingblock"><div class="content"><pre>[root@workstation ~]# rbd --id admin -p images ls</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre>bd66c2ea-55d5-4463-9d33-779812aae2d9</pre></div></div>
<div class="ulist"><ul><li><p>The ID should match the Glance image ID.</p></li></ul></div></li></ol></div></div>
<div class="sect2"><h3 id="_define_flavors_in_overcloud">Define Flavors in Overcloud</h3><div class="olist arabic"><ol class="arabic"><li><p>List flavors defined in the overcloud:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud) [stack@undercloud ~]$ openstack flavor list</pre></div></div></li><li><p>Create the <code>m1.tiny</code> flavor if it has not been defined before:</p><div class="listingblock"><div class="content"><pre>(overcloud) [stack@undercloud ~]$ openstack flavor create --ram 512 --disk 1 --vcpus 1 m1.tiny</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre>+----------------------------+--------------------------------------+
| Field                      | Value                                |
+----------------------------+--------------------------------------+
| OS-FLV-DISABLED:disabled   | False                                |
| OS-FLV-EXT-DATA:ephemeral  | 0                                    |
| description                | None                                 |
| disk                       | 1                                    |
| extra_specs                | {}                                   |
| id                         | 6fd01d7c-fe99-48ad-825b-c1c44c429f53 |
| name                       | m1.tiny                              |
| os-flavor-access:is_public | True                                 |
| properties                 |                                      |
| ram                        | 512                                  |
| rxtx_factor                | 1.0                                  |
| swap                       | 0                                    |
| vcpus                      | 1                                    |
+----------------------------+--------------------------------------+</pre></div></div></li></ol></div></div>
<div class="sect2"><h3 id="_create_a_tenant_in_overcloud">Create a Tenant in Overcloud</h3><div class="olist arabic"><ol class="arabic"><li><p>Create a non-admin tenant and user:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud) [stack@undercloud ~]$ openstack project create test
(overcloud) [stack@undercloud ~]$ openstack user create --project test --password r3dh4t1! test
(overcloud) [stack@undercloud ~]$ openstack role add --user test --project test member</pre></div></div></li><li><p>Create a shell RC file for the <code>test</code> user:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud) [stack@undercloud ~]$ sed -e 's/=admin/=test/' -e 's/OS_PASSWORD=.*/OS_PASSWORD=r3dh4t1!/' -e 's/OS_CLOUDNAME=overcloud/OS_CLOUDNAME=overcloud_test/' overcloudrc &gt; ~/testrc</pre></div></div></li></ol></div></div>
<div class="sect2"><h3 id="_set_tenant_networking_in_overcloud">Set Tenant Networking in Overcloud</h3><div class="paragraph"><p>Create a network, subnet, and router on behalf of the <code>test</code> user.</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Switch to the <code>test</code> user profile:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud) [stack@undercloud ~]$ source ~/testrc</pre></div></div></li><li><p>Create the <code>test</code> network:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack network create test</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+---------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field                     | Value                                                                                                                                                           |
+---------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+
| admin_state_up            | UP                                                                                                                                                              |
| availability_zone_hints   |                                                                                                                                                                 |
| availability_zones        |                                                                                                                                                                 |
| created_at                | 2020-06-13T13:02:39Z                                                                                                                                            |
| description               |                                                                                                                                                                 |
| dns_domain                |                                                                                                                                                                 |
| id                        | 33ab5aae-088d-4388-a90b-8c3d9096086a                                                                                                                            |
| ipv4_address_scope        | None                                                                                                                                                            |
| ipv6_address_scope        | None                                                                                                                                                            |
| is_default                | False                                                                                                                                                           |
| is_vlan_transparent       | None                                                                                                                                                            |
| location                  | cloud='', project.domain_id=, project.domain_name='Default', project.id='ac62b39dead64f4e84c9744fa0b97071', project.name='test', region_name='regionOne', zone= |
| mtu                       | 1442                                                                                                                                                            |
| name                      | test                                                                                                                                                            |
| port_security_enabled     | True                                                                                                                                                            |
| project_id                | ac62b39dead64f4e84c9744fa0b97071                                                                                                                                |
| provider:network_type     | None                                                                                                                                                            |
| provider:physical_network | None                                                                                                                                                            |
| provider:segmentation_id  | None                                                                                                                                                            |
| qos_policy_id             | None                                                                                                                                                            |
| revision_number           | 1                                                                                                                                                               |
| router:external           | Internal                                                                                                                                                        |
| segments                  | None                                                                                                                                                            |
| shared                    | False                                                                                                                                                           |
| status                    | ACTIVE                                                                                                                                                          |
| subnets                   |                                                                                                                                                                 |
| tags                      |                                                                                                                                                                 |
| updated_at                | 2020-06-13T13:02:40Z                                                                                                                                            |
+---------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+</pre></div></div></li><li><p>Create the <code>test</code> subnet:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack subnet create \
 --network test \
 --gateway 192.168.123.254 \
 --allocation-pool start=192.168.123.1,end=192.168.123.253 \
 --dns-nameserver 8.8.8.8 \
 --subnet-range 192.168.123.0/24 \
 test</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field             | Value                                                                                                                                                           |
+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+
| allocation_pools  | 192.168.123.1-192.168.123.253                                                                                                                                   |
| cidr              | 192.168.123.0/24                                                                                                                                                |
| created_at        | 2020-06-13T13:03:07Z                                                                                                                                            |
| description       |                                                                                                                                                                 |
| dns_nameservers   | 8.8.8.8                                                                                                                                                         |
| enable_dhcp       | True                                                                                                                                                            |
| gateway_ip        | 192.168.123.254                                                                                                                                                 |
| host_routes       |                                                                                                                                                                 |
| id                | e4c902ab-dc56-474a-b777-ff3047ea22f9                                                                                                                            |
| ip_version        | 4                                                                                                                                                               |
| ipv6_address_mode | None                                                                                                                                                            |
| ipv6_ra_mode      | None                                                                                                                                                            |
| location          | cloud='', project.domain_id=, project.domain_name='Default', project.id='ac62b39dead64f4e84c9744fa0b97071', project.name='test', region_name='regionOne', zone= |
| name              | test                                                                                                                                                            |
| network_id        | 33ab5aae-088d-4388-a90b-8c3d9096086a                                                                                                                            |
| prefix_length     | None                                                                                                                                                            |
| project_id        | ac62b39dead64f4e84c9744fa0b97071                                                                                                                                |
| revision_number   | 0                                                                                                                                                               |
| segment_id        | None                                                                                                                                                            |
| service_types     |                                                                                                                                                                 |
| subnetpool_id     | None                                                                                                                                                            |
| tags              |                                                                                                                                                                 |
| updated_at        | 2020-06-13T13:03:07Z                                                                                                                                            |
+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+</pre></div></div></li><li><p>Create the <code>test</code> router:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack router create test</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+-------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field                   | Value                                                                                                                                                           |
+-------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+
| admin_state_up          | UP                                                                                                                                                              |
| availability_zone_hints | None                                                                                                                                                            |
| availability_zones      | None                                                                                                                                                            |
| created_at              | 2020-06-13T13:03:27Z                                                                                                                                            |
| description             |                                                                                                                                                                 |
| external_gateway_info   | null                                                                                                                                                            |
| flavor_id               | None                                                                                                                                                            |
| id                      | 773149b6-302c-486e-ab1e-5879f66eccfe                                                                                                                            |
| location                | cloud='', project.domain_id=, project.domain_name='Default', project.id='ac62b39dead64f4e84c9744fa0b97071', project.name='test', region_name='regionOne', zone= |
| name                    | test                                                                                                                                                            |
| project_id              | ac62b39dead64f4e84c9744fa0b97071                                                                                                                                |
| revision_number         | 0                                                                                                                                                               |
| routes                  |                                                                                                                                                                 |
| status                  | ACTIVE                                                                                                                                                          |
| tags                    |                                                                                                                                                                 |
| updated_at              | 2020-06-13T13:03:27Z                                                                                                                                            |
+-------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+</pre></div></div></li><li><p>Set gateway for the <code>test</code> router:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack router set --external-gateway public test</pre></div></div></li><li><p>Connect the <code>test</code> router to the <code>test</code> subnet:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack router add subnet test test</pre></div></div></li><li><p>Add a security group rule to allow inbound SSH:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack security group rule create \
 --ingress \
 --ethertype IPv4 \
 --protocol tcp \
 --dst-port 22 \
  default</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field             | Value                                                                                                                                                           |
+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+
| created_at        | 2020-06-13T13:04:33Z                                                                                                                                            |
| description       |                                                                                                                                                                 |
| direction         | ingress                                                                                                                                                         |
| ether_type        | IPv4                                                                                                                                                            |
| id                | 44f0235e-fd86-4454-9213-794b0f0e87f8                                                                                                                            |
| location          | cloud='', project.domain_id=, project.domain_name='Default', project.id='ac62b39dead64f4e84c9744fa0b97071', project.name='test', region_name='regionOne', zone= |
| name              | None                                                                                                                                                            |
| port_range_max    | 22                                                                                                                                                              |
| port_range_min    | 22                                                                                                                                                              |
| project_id        | ac62b39dead64f4e84c9744fa0b97071                                                                                                                                |
| protocol          | tcp                                                                                                                                                             |
| remote_group_id   | None                                                                                                                                                            |
| remote_ip_prefix  | 0.0.0.0/0                                                                                                                                                       |
| revision_number   | 0                                                                                                                                                               |
| security_group_id | 96a27b76-a41c-4b2c-ac88-b712bcf73f28                                                                                                                            |
| tags              | []                                                                                                                                                              |
| updated_at        | 2020-06-13T13:04:33Z                                                                                                                                            |
+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+</pre></div></div></li><li><p>Add security group rule to allow inbound ICMP:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack security group rule create \
 --ingress \
 --ethertype IPv4 \
 --protocol icmp \
 default</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field             | Value                                                                                                                                                           |
+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+
| created_at        | 2020-06-13T13:04:50Z                                                                                                                                            |
| description       |                                                                                                                                                                 |
| direction         | ingress                                                                                                                                                         |
| ether_type        | IPv4                                                                                                                                                            |
| id                | cf823e32-b058-40b6-b35b-4e29a24c32b7                                                                                                                            |
| location          | cloud='', project.domain_id=, project.domain_name='Default', project.id='ac62b39dead64f4e84c9744fa0b97071', project.name='test', region_name='regionOne', zone= |
| name              | None                                                                                                                                                            |
| port_range_max    | None                                                                                                                                                            |
| port_range_min    | None                                                                                                                                                            |
| project_id        | ac62b39dead64f4e84c9744fa0b97071                                                                                                                                |
| protocol          | icmp                                                                                                                                                            |
| remote_group_id   | None                                                                                                                                                            |
| remote_ip_prefix  | 0.0.0.0/0                                                                                                                                                       |
| revision_number   | 0                                                                                                                                                               |
| security_group_id | 96a27b76-a41c-4b2c-ac88-b712bcf73f28                                                                                                                            |
| tags              | []                                                                                                                                                              |
| updated_at        | 2020-06-13T13:04:50Z                                                                                                                                            |
+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------+</pre></div></div></li><li><p>List the defined security groups:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack security group list</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+--------------------------------------+---------+------------------------+----------------------------------+------+
| ID                                   | Name    | Description            | Project                          | Tags |
+--------------------------------------+---------+------------------------+----------------------------------+------+
| 96a27b76-a41c-4b2c-ac88-b712bcf73f28 | default | Default security group | ac62b39dead64f4e84c9744fa0b97071 | []   |
+--------------------------------------+---------+------------------------+----------------------------------+------+</pre></div></div></li><li><p>Review the <code>default</code> security group of the <code>test</code> user:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack security group show default</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field           | Value                                                                                                                                                                                                                                          |
+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| created_at      | 2020-06-13T13:02:39Z                                                                                                                                                                                                                           |
| description     | Default security group                                                                                                                                                                                                                         |
| id              | 96a27b76-a41c-4b2c-ac88-b712bcf73f28                                                                                                                                                                                                           |
| location        | cloud='', project.domain_id=, project.domain_name='Default', project.id='ac62b39dead64f4e84c9744fa0b97071', project.name='test', region_name='regionOne', zone=                                                                                |
| name            | default                                                                                                                                                                                                                                        |
| project_id      | ac62b39dead64f4e84c9744fa0b97071                                                                                                                                                                                                               |
| revision_number | 3                                                                                                                                                                                                                                              |
| rules           | created_at='2020-06-13T13:04:33Z', direction='ingress', ethertype='IPv4', id='44f0235e-fd86-4454-9213-794b0f0e87f8', port_range_max='22', port_range_min='22', protocol='tcp', remote_ip_prefix='0.0.0.0/0', updated_at='2020-06-13T13:04:33Z' |
|                 | created_at='2020-06-13T13:02:39Z', direction='ingress', ethertype='IPv6', id='7477310b-d353-4aaa-b84e-a4406c2bec9b', remote_group_id='96a27b76-a41c-4b2c-ac88-b712bcf73f28', updated_at='2020-06-13T13:02:39Z'                                 |
|                 | created_at='2020-06-13T13:02:39Z', direction='ingress', ethertype='IPv4', id='8581ff89-cf05-4ac8-96c0-a90ed6420c5a', remote_group_id='96a27b76-a41c-4b2c-ac88-b712bcf73f28', updated_at='2020-06-13T13:02:39Z'                                 |
|                 | created_at='2020-06-13T13:02:39Z', direction='egress', ethertype='IPv4', id='bc0ea127-23be-4f10-8822-353b4447b3ac', updated_at='2020-06-13T13:02:39Z'                                                                                          |
|                 | created_at='2020-06-13T13:04:50Z', direction='ingress', ethertype='IPv4', id='cf823e32-b058-40b6-b35b-4e29a24c32b7', protocol='icmp', remote_ip_prefix='0.0.0.0/0', updated_at='2020-06-13T13:04:50Z'                                          |
|                 | created_at='2020-06-13T13:02:39Z', direction='egress', ethertype='IPv6', id='e19c60a3-9920-4296-ba49-b7c922c9f2a4', updated_at='2020-06-13T13:02:39Z'                                                                                          |
| tags            | []                                                                                                                                                                                                                                             |
| updated_at      | 2020-06-13T13:04:50Z                                                                                                                                                                                                                           |
+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</pre></div></div></li><li><p>Import an SSH key:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack keypair create --public-key ~/.ssh/id_rsa.pub stack</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+-------------+-------------------------------------------------+
| Field       | Value                                           |
+-------------+-------------------------------------------------+
| fingerprint | 01:76:32:41:10:b0:a2:82:5a:e5:b8:dc:4e:e0:dd:fd |
| name        | stack                                           |
| type        | ssh                                             |
| user_id     | 21fe523cde0c42e1b56b5c4e197acdb7                |
+-------------+-------------------------------------------------+</pre></div></div></li><li><p>Create a floating IP for allocation:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack floating ip create public</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+---------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field               | Value                                                                                                                                                                                     |
+---------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| created_at          | 2020-06-13T13:06:29Z                                                                                                                                                                      |
| description         |                                                                                                                                                                                           |
| dns_domain          |                                                                                                                                                                                           |
| dns_name            |                                                                                                                                                                                           |
| fixed_ip_address    | None                                                                                                                                                                                      |
| floating_ip_address | 10.0.0.104                                                                                                                                                                                |
| floating_network_id | 1ccc7a4e-4766-41a5-aff1-b0b949509a20                                                                                                                                                      |
| id                  | 9a591441-b3e9-49cf-a7bb-207d0025a74d                                                                                                                                                      |
| location            | Munch({'cloud': '', 'region_name': 'regionOne', 'zone': None, 'project': Munch({'id': 'ac62b39dead64f4e84c9744fa0b97071', 'name': 'test', 'domain_id': None, 'domain_name': 'Default'})}) |
| name                | 10.0.0.104                                                                                                                                                                                |
| port_details        | None                                                                                                                                                                                      |
| port_id             | None                                                                                                                                                                                      |
| project_id          | ac62b39dead64f4e84c9744fa0b97071                                                                                                                                                          |
| qos_policy_id       | None                                                                                                                                                                                      |
| revision_number     | 0                                                                                                                                                                                         |
| router_id           | None                                                                                                                                                                                      |
| status              | DOWN                                                                                                                                                                                      |
| subnet_id           | None                                                                                                                                                                                      |
| tags                | []                                                                                                                                                                                        |
| updated_at          | 2020-06-13T13:06:29Z                                                                                                                                                                      |
+---------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="icon-note" title="Note"></i></td><td class="content">Use the IP shown on the field <code>floating_ip_address</code> for the next tasks instead <code>10.0.0.104</code></td></tr></table></div></li></ol></div></div>
<div class="sect2"><h3 id="_create_an_instance_in_overcloud">Create an Instance in Overcloud</h3><div class="olist arabic"><ol class="arabic"><li><p>Create an instance on behalf of the <code>test</code> user:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack server create  --flavor m1.tiny \
 --image cirros  --key-name stack \
 --security-group default \
 --network test test</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+-----------------------------+------------------------------------------------+
| Field                       | Value                                          |
+-----------------------------+------------------------------------------------+
| OS-DCF:diskConfig           | MANUAL                                         |
| OS-EXT-AZ:availability_zone |                                                |
| OS-EXT-STS:power_state      | NOSTATE                                        |
| OS-EXT-STS:task_state       | scheduling                                     |
| OS-EXT-STS:vm_state         | building                                       |
| OS-SRV-USG:launched_at      | None                                           |
| OS-SRV-USG:terminated_at    | None                                           |
| accessIPv4                  |                                                |
| accessIPv6                  |                                                |
| addresses                   |                                                |
| adminPass                   | W9t9F2WSqxhj                                   |
| config_drive                |                                                |
| created                     | 2019-01-15T05:40:42Z                           |
| flavor                      | m1.tiny (d591badc-7290-4591-b368-54909fdcc5e1) |
| hostId                      |                                                |
| id                          | b25ab2b2-63bb-45a1-8431-62a9e13e98ec           |
| image                       | cirros (d8e41f75-ff3c-4a4d-a6df-5b2e528bc52e)  |
| key_name                    | stack                                          |
| name                        | test                                           |
| progress                    | 0                                              |
| project_id                  | 761c5ae81e324755b3b6450b181a19d9               |
| properties                  |                                                |
| security_groups             | name='8a99f1e2-33d5-4c14-bc0e-45fe5d2b0799'    |
| status                      | BUILD                                          |
| updated                     | 2019-01-15T05:40:43Z                           |
| user_id                     | 553f1031988a4cc8a71c16dc08edc657               |
| volumes_attached            |                                                |
+-----------------------------+------------------------------------------------+</pre></div></div></li><li><p>Wait for the requested instance to reach the <code>ACTIVE</code> state:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack server list</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+--------------------------------------+------+--------+----------------------+--------+--------+
| ID                                   | Name | Status | Networks             | Image  | Flavor |
+--------------------------------------+------+--------+----------------------+--------+--------+
| e50978b3-095f-4b81-b70d-0862e20cea0e | test | ACTIVE | test=192.168.123.110 | cirros |        |
+--------------------------------------+------+--------+----------------------+--------+--------+</pre></div></div></li><li><p>Associate the floating IP with the instance:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack server add floating ip test 10.0.0.104</pre></div></div></li><li><p>Validate that the IP is assigned:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ openstack server list</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+--------------------------------------+------+--------+----------------------------------+--------+--------+
| ID                                   | Name | Status | Networks                         | Image  | Flavor |
+--------------------------------------+------+--------+----------------------------------+--------+--------+
| e50978b3-095f-4b81-b70d-0862e20cea0e | test | ACTIVE | test=192.168.123.110, 10.0.0.104 | cirros |        |
+--------------------------------------+------+--------+----------------------------------+--------+--------+</pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="icon-note" title="Note"></i></td><td class="content">The floating IP can take few seconds to appear in the list here, so you may need to check it a few times.</td></tr></table></div></li><li><p>Test access to the instance via the floating IP:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ ping -c 3 10.0.0.104</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">PING 10.0.0.104 (10.0.0.104) 56(84) bytes of data.
64 bytes from 10.0.0.104: icmp_seq=1 ttl=62 time=1.90 ms
64 bytes from 10.0.0.104: icmp_seq=2 ttl=62 time=2.28 ms
64 bytes from 10.0.0.104: icmp_seq=3 ttl=62 time=1.74 ms

--- 10.0.0.104 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 4ms
rtt min/avg/max/mdev = 1.744/1.973/2.281/0.231 ms</pre></div></div></li><li><p>SSH into the instance as the <code>cirros</code> user:</p><div class="listingblock"><div class="content"><pre class="nowrap">(overcloud_test) [stack@undercloud ~]$ ssh cirros@10.0.0.104</pre></div></div></li><li><p>Verify that the instance has connectivity to the global Internet:</p><div class="listingblock"><div class="title">[test]</div><div class="content"><pre class="nowrap">$ ping -c3 google.com</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">PING google.com (172.217.7.238): 56 data bytes
64 bytes from 172.217.7.238: seq=0 ttl=48 time=21.908 ms
64 bytes from 172.217.7.238: seq=1 ttl=48 time=22.048 ms
64 bytes from 172.217.7.238: seq=2 ttl=48 time=22.058 ms

--- google.com ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 21.908/22.004/22.058 ms</pre></div></div></li><li><p>Check the Ceph pools (on the controllers) and verify that the instance&#8217;s ephemeral disk has been effectively created in Ceph:</p><div class="listingblock"><div class="content"><pre class="nowrap">[root@workstation ~]# rbd  -p vms ls</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre>e50978b3-095f-4b81-b70d-0862e20cea0e_disk</pre></div></div>
<div class="ulist"><ul><li><p>Notice that the Ceph image disk contains the instance&#8217;s ID followed by <code>_disk</code>.</p></li></ul></div></li></ol></div>
<div class="paragraph"><p>There we are! A fully HA, External Ceph enabled RH OSP 16 with network isolation and bonding!</p></div></div></div></div>
<div class="sect1"><h2 id="_service_telemetry_framework">Service Telemetry Framework</h2><div class="sectionbody"><div class="sect2"><h3 id="_validating_the_installation">Validating the installation</h3><div class="olist arabic"><ol class="arabic"><li><p>Login to one of the controllers</p><div class="listingblock"><div class="content"><pre class="nowrap">[stack@undercloud ~]$ ssh heat-admin@lab-controller01.ctlplane</pre></div></div></li><li><p>List the containers for metrics, collectd and ceilometer</p><div class="listingblock"><div class="content"><pre class="nowrap">[heat-admin@lab-controller01 ~]$ sudo podman ps -f name=metrics
CONTAINER ID  IMAGE                                                                         COMMAND      CREATED     STATUS         PORTS  NAMES
e038d5c11f08  undercloud.ctlplane.localdomain:8787/rhosp-rhel8/openstack-qdrouterd:16.0-82  kolla_start  2 days ago  Up 2 days ago         metrics_qdr
[heat-admin@lab-controller01 ~]$ sudo podman ps -f name=ceilometer
CONTAINER ID  IMAGE                                                                                       COMMAND      CREATED     STATUS         PORTS  NAMES
1c5cef618848  undercloud.ctlplane.localdomain:8787/rhosp-rhel8/openstack-ceilometer-notification:16.0-78  kolla_start  2 days ago  Up 2 days ago         ceilometer_agent_notification
1f06544713a9  undercloud.ctlplane.localdomain:8787/rhosp-rhel8/openstack-ceilometer-central:16.0-74       kolla_start  2 days ago  Up 2 days ago         ceilometer_agent_central
[heat-admin@lab-controller01 ~]$ sudo podman ps -f name=collectd
CONTAINER ID  IMAGE                                                                        COMMAND      CREATED     STATUS         PORTS  NAMES
0cacd8f3c41f  undercloud.ctlplane.localdomain:8787/rhosp-rhel8/openstack-collectd:16.0-77  kolla_start  2 days ago  Up 2 days ago         collectd</pre></div></div></li><li><p>Review <code>qdrouterd</code> configuration on <code>metrics_qdr</code> container<br>
+<br>
[%nowrap]<br>
----<br>
[heat-admin@lab-controller01 ~]$ sudo podman exec -it metrics_qdr cat /etc/qpid-dispatch/qdrouterd.conf<br>
----</p></li><li><p>Set the IP on a variable</p><div class="listingblock"><div class="content"><pre class="nowrap">[heat-admin@lab-controller01 ~]$ QIP=172.17.0.201</pre></div></div></li><li><p>List of connections to the local AMQ Interconnect</p><div class="listingblock"><div class="content"><pre class="nowrap">[heat-admin@lab-controller01 ~]$ sudo podman exec -it metrics_qdr qdstat --bus=$QIP:5666 --connections</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">Connections
  id     host                                                                  container                                                                                                      role    dir  security                            authentication  tenant
  =====================================================================================================================================================================================================================================================================
  296    172.17.0.201:37662                                                    metrics                                                                                                        normal  in   no-security                         anonymous-user
  2008   172.17.0.201:56328                                                    openstack.org/om/container/lab-controller01/ceilometer-agent-notification/25/b8b8a9d486ce4a809ed7245f9375d0b9  normal  in   no-security                         no-auth
  36560  stf-default-interconnect-5671-service-telemetry.apps-crc.testing:443  stf-default-interconnect-7458fd4d69-qpkfj                                                                      edge    out  TLSv1.2(DHE-RSA-AES256-GCM-SHA384)  anonymous-user
  36561  172.17.0.201:47238                                                    39d81f46-b2b0-4c3b-bd0f-6fb47ba2fd1f                                                                           normal  in   no-security                         no-auth</pre></div></div>
<div class="paragraph"><p>There are four connections:</p></div>
<div class="ulist"><ul><li><p>Outbound connection to STF</p></li><li><p>Inbound connection from collectd</p></li><li><p>Inbound connection from ceilometer</p></li><li><p>Inbound connection from our qdstat client</p></li></ul></div></li><li><p>List the router links to ensure messages are being delivered</p><div class="listingblock"><div class="content"><pre class="nowrap">[heat-admin@lab-controller01 ~]$ sudo podman exec -it metrics_qdr qdstat --bus=$QIP:5666 --links |grep  --color=never  -e Router -e type -e === -e _edge</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">Router Links
  type      dir  conn id  id    peer  class   addr                  phs  cap  pri  undel  unsett  deliv    presett  psdrop  acc  rej  rel  mod  delay  rate
  ===========================================================================================================================================================
  endpoint  out  36560    3904        local   _edge                      250  0    0      0       7968     7968     0       0    0    0    0    0      33</pre></div></div></li><li><p>On OpenShift review the connections from RHOSP</p><div class="listingblock"><div class="content"><pre class="nowrap">[student@pool04-iad ~]$ cd crc-linux-1.9.0-amd64/
[student@pool04-iad crc-linux-1.9.0-amd64]$ eval $(./crc oc-env)
[student@pool04-iad crc-linux-1.9.0-amd64]$ oc login -u kubeadmin -p XXX https://api.crc.testing:6443
[student@pool04-iad crc-linux-1.9.0-amd64]$ POD=$(oc get pods -l application=stf-default-interconnect  -o custom-columns=POD:.metadata.name --no-headers)
[student@pool04-iad crc-linux-1.9.0-amd64]$ oc exec -it  $POD -- qdstat --connections</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">2020-06-14 10:45:40.670955 UTC
stf-default-interconnect-7458fd4d69-qpkfj

Connections
  id  host                container                                                             role    dir  security                                authentication  tenant  last dlv      uptime
  =======================================================================================================================================================================================================
  1   10.128.0.149:55278  rcv[stf-default-collectd-telemetry-smartgateway-6bf44df64-spndd]      normal  in   no-security                             anonymous-user          000:00:00:00  002:20:56:58
  2   10.128.0.152:53532  rcv[stf-default-ceilometer-notification-smartgateway-5d9dccc84w84p6]  normal  in   no-security                             anonymous-user          -             002:20:56:09
  3   10.128.0.151:34854  rcv[stf-default-collectd-notification-smartgateway-bbb54d5cb-fwph4]   normal  in   no-security                             anonymous-user          -             002:20:56:04
  4   10.128.0.1:60376    Router.lab-controller03.localdomain                                   edge    in   TLSv1/SSLv3(DHE-RSA-AES256-GCM-SHA384)  anonymous-user          000:00:00:00  000:00:07:31
  5   10.128.0.1:60398    Router.lab-controller02.localdomain                                   edge    in   TLSv1/SSLv3(DHE-RSA-AES256-GCM-SHA384)  anonymous-user          000:00:00:01  000:00:07:30
  6   10.128.0.1:60414    Router.lab-compute01.localdomain                                      edge    in   TLSv1/SSLv3(DHE-RSA-AES256-GCM-SHA384)  anonymous-user          000:00:00:01  000:00:07:29
  7   10.128.0.1:60466    Router.lab-controller01.localdomain                                   edge    in   TLSv1/SSLv3(DHE-RSA-AES256-GCM-SHA384)  anonymous-user          000:00:00:03  000:00:07:27
  8   10.128.0.1:60470    Router.lab-compute02.localdomain                                      edge    in   TLSv1/SSLv3(DHE-RSA-AES256-GCM-SHA384)  anonymous-user          000:00:00:02  000:00:07:27
  11  127.0.0.1:33220     61a3c95a-a9e5-480f-b1d2-460fc2184774                                  normal  in   no-security                             no-auth                 000:00:00:00  000:00:00:00</pre></div></div></li><li><p>Review the number of messges received</p><div class="listingblock"><div class="content"><pre class="nowrap">[student@pool04-iad crc-linux-1.9.0-amd64]$ oc exec -it  $POD -- qdstat --address |grep --color=never -e stf -e Addresses -e class -e === -e telemetry</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">stf-default-interconnect-7458fd4d69-qpkfj
Router Addresses
  class   addr                                 phs  distrib    pri  local  remote  in      out     thru  fallback
  =================================================================================================================
  mobile  collectd/telemetry                   0    multicast  -    1      0       89,425  89,425  0     0</pre></div></div></li><li><p>Install graphical environment on workstation</p><div class="listingblock"><div class="content"><pre class="nowrap">[root@pool04-iad ~]# ssh 192.0.2.249
[root@workstation ~]# dnf groupinstall "Workstation" -y</pre></div></div></li><li><p>Set the graphical environment as default and restart the system</p><div class="listingblock"><div class="content"><pre class="nowrap">[root@workstation ~]# systemctl set-default graphical
Removed /etc/systemd/system/default.target.
Created symlink /etc/systemd/system/default.target  /usr/lib/systemd/system/graphical.target.
[root@workstation ~]# reboot</pre></div></div></li><li><p>Access using cockpit to the graphical environment of <code>workstation</code> VM</p></li><li><p>Open firefox inside and navigate to <code>https://grafana-route-service-telemetry.apps-crc.testing</code></p></li><li><p>Navigate to "Infrastructure Node View" dasboard. Select one of the controllers and scroll down.</p></li></ol></div></div></div></div>
<div class="sect1"><h2 id="_fernet_keys">Fernet Keys</h2><div class="sectionbody"><div class="sect2"><h3 id="_review_the_fernet_deployment">Review the Fernet Deployment</h3><div class="paragraph"><p>This procedure reviews your configuration to confirm that Fernet tokens are working correctly.</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Connect to one of the controllers:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ ssh heat-admin@lab-controller01.ctlplane</pre></div></div></li><li><p>Retrieve the values of the token driver and provider settings:</p><div class="listingblock"><div class="title">[controller]</div><div class="content"><pre class="nowrap">[heat-admin@lab-controller01 ~]$ sudo crudini --get /var/lib/config-data/puppet-generated/keystone/etc/keystone/keystone.conf token provider
fernet</pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="icon-note" title="Note"></i></td><td class="content">Notice the provider by default is <code>fernet</code>.</td></tr></table></div></li><li><p>Disconnect from controller:</p><div class="listingblock"><div class="title">[controller]</div><div class="content"><pre class="nowrap">[heat-admin@lab-controller01 ~]$ exit</pre></div></div></li><li><p>Test the Fernet provider:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ source ~/overcloudrc
(overcloud) [stack@undercloud ~]$ openstack token issue</pre></div></div>
<div class="listingblock"><div class="content"><pre class="nowrap">+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field      | Value                                                                                                                                                                                   |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| expires    | 2020-06-13T14:17:58+0000                                                                                                                                                                |
| id         | gAAAAABe5NIG-WuOpbG_i0OufcPoh9yirBD8jp9AHw9wC3SOJJ6zcCuYkY2yrLEUqvZ9KZcvOnadw-89LuaJcI5QdCFKZTG3K5SARbOEtrrZBpLSjoHP4I6TEHUHrmUzYSY81zN1n8PdoETm-_sKLd1NR3QcRLpyxA8Y7eGKr91ZXWv_YIHtokE |
| project_id | d8e329a2859240ad953956d8cba7c230                                                                                                                                                        |
| user_id    | 3daae283af2b40b6bffe3c88c949846e                                                                                                                                                        |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</pre></div></div>
<div class="paragraph"><p>The <code>id</code> is a long <code>Fernet</code> token.</p></div></li></ol></div></div>
<div class="sect2"><h3 id="_rotate_the_fernet_keys">Rotate the Fernet keys</h3><div class="paragraph"><p>It is recommended that you rotate your Fernet keys regularly, as a compromised keystone key can allow an attacker to generate their own tokens and subsequently grant themselves access to a project.</p></div>
<div class="paragraph"><p>Fernet uses three types of keys, which are stored in <code>/var/lib/config-data/puppet-generated/keystone/etc/keystone/fernet-keys</code>. The highest-numbered directory contains the primary key, which is used to generate new tokens and decrypt existing ones.</p></div>
<div class="paragraph"><p>During the key rotation process, the primary key is relegated to secondary key status, and a new primary key is issued, thereby reducing the value of a compromised primary key. Secondary keys can only be used to decrypt tokens that were created with previous primary keys, and cannot issue new ones.</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Review existing keys:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ ssh heat-admin@lab-controller01.ctlplane
[heat-admin@lab-controller01 ~]$ sudo crudini --get /var/lib/config-data/puppet-generated/keystone/etc/keystone/keystone.conf fernet_tokens key_repository</pre></div></div>
<div class="listingblock"><div class="title">Expected Output</div><div class="content"><pre class="nowrap">/etc/keystone/fernet-keys</pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="icon-note" title="Note"></i></td><td class="content">The <code>/etc/keystone/</code> directory refers to the container file system path.</td></tr></table></div></li><li><p>Review the current Fernet key directories:</p><div class="listingblock"><div class="title">[controller]</div><div class="content"><pre class="nowrap">[heat-admin@lab-controller01 ~]$ sudo ls /var/lib/config-data/puppet-generated/keystone/etc/keystone/fernet-keys</pre></div></div>
<div class="listingblock"><div class="title">Expected Output</div><div class="content"><pre class="nowrap">0  1</pre></div></div>
<div class="paragraph"><p>The key named with the highest index, 1 in this case, is considered the primary key. The file named 0 is always reserved as the staged key.</p></div></li><li><p>Check the current primary Fernet key and the staged key:</p><div class="listingblock"><div class="title">Primary key</div><div class="content"><pre class="nowrap">[heat-admin@lab-controller01 ~]$ sudo cat /var/lib/config-data/puppet-generated/keystone/etc/keystone/fernet-keys/1</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">dSEJgb6ghEz9zt2B8_yXnTPL2iOn7GLih2Ajpza0oY0=</pre></div></div>
<div class="listingblock"><div class="title">Staged key</div><div class="content"><pre class="nowrap">[heat-admin@lab-controller01 ~]$ sudo cat /var/lib/config-data/puppet-generated/keystone/etc/keystone/fernet-keys/0</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">urUVR5zQRZg49cEFDPIbDLErk_Uw4CVsjLrcXCgzGxA=</pre></div></div></li><li><p>Rotate the Fernet keys using the Mistral workflow:</p><div class="listingblock"><div class="content"><pre class="nowrap">[heat-admin@lab-controller01 ~]$ exit
(overcloud) [stack@undercloud ~]$ source ~/stackrc
(undercloud) [stack@undercloud ~]$ openstack workflow execution create tripleo.fernet_keys.v1.rotate_fernet_keys '{"container": "overcloud"}'</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+--------------------+-------------------------------------------+
| Field              | Value                                     |
+--------------------+-------------------------------------------+
| ID                 | 556e6dad-423b-49db-9794-c79005a1979c      |
| Workflow ID        | 3bd6985b-54c6-4cb3-8f24-3d41f868a598      |
| Workflow name      | tripleo.fernet_keys.v1.rotate_fernet_keys |
| Workflow namespace |                                           |
| Description        |                                           |
| Task Execution ID  | &lt;none&gt;                                    |
| State              | RUNNING                                   |
| State info         | None                                      |
| Created at         | 2019-02-07 15:39:33                       |
| Updated at         | 2019-02-07 15:39:33                       |
+--------------------+-------------------------------------------+</pre></div></div></li><li><p>Check the rotation status:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ openstack workflow execution show 556e6dad-423b-49db-9794-c79005a1979c</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+--------------------+-------------------------------------------+
| Field              | Value                                     |
+--------------------+-------------------------------------------+
| ID                 | 556e6dad-423b-49db-9794-c79005a1979c      |
| Workflow ID        | 3bd6985b-54c6-4cb3-8f24-3d41f868a598      |
| Workflow name      | tripleo.fernet_keys.v1.rotate_fernet_keys |
| Workflow namespace |                                           |
| Description        |                                           |
| Task Execution ID  | &lt;none&gt;                                    |
| State              | SUCCESS                                   |
| State info         | None                                      |
| Created at         | 2019-02-07 15:39:33                       |
| Updated at         | 2019-02-07 15:40:50                       |
+--------------------+-------------------------------------------+</pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="icon-note" title="Note"></i></td><td class="content">Wait some minutes till <code>State</code> is <code>SUCCESS</code>.</td></tr></table></div></li><li><p>Review on one of the controllers the Fernet keys:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ ssh heat-admin@lab-controller01.ctlplane
[heat-admin@lab-controller01 ~]$ sudo ls /var/lib/config-data/puppet-generated/keystone/etc/keystone/fernet-keys</pre></div></div>
<div class="listingblock"><div class="content"><pre class="nowrap">0  1  2</pre></div></div>
<div class="ulist"><ul><li><p><code>0</code> - Contains the <strong>staged key</strong>, (which becomes the next primary key) and will always be numbered 0.</p></li><li><p><code>1</code> - Contains the <strong>secondary key</strong>.</p></li><li><p><code>2</code> - Contains the <strong>primary key</strong>. This number will increment each time the keys are rotated, with the highest number always serving as the primary key.</p><div class="listingblock"><div class="content"><pre class="nowrap">[heat-admin@lab-controller01 ~]$ sudo cat /var/lib/config-data/puppet-generated/keystone/etc/keystone/fernet-keys/2</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">urUVR5zQRZg49cEFDPIbDLErk_Uw4CVsjLrcXCgzGxA=</pre></div></div>
<div class="paragraph"><p>Notice <code>primary key</code> now was the <code>staged key</code> before.</p></div></li></ul></div></li></ol></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="icon-note" title="Note"></i></td><td class="content">The keys are propagated across all controllers.</td></tr></table></div></div></div></div>
<div class="sect1"><h2 id="_overcloud_validations">Overcloud Validations</h2><div class="sectionbody"><div class="paragraph"><p><strong>Red Hat OpenStack Platform</strong> includes a validation framework that you can use to verify the requirements and functionality of the undercloud and overcloud. The framework includes two types of validations:</p></div>
<div class="ulist"><ul><li><p>Manual Ansible-based validations, which you execute through the openstack tripleo validator command set.</p></li><li><p>Automatic in-flight validations, which execute during the deployment process.</p></li></ul></div>
<div class="sect2"><h3 id="_run_an_overcloud_validation">Run an overcloud validation</h3><div class="paragraph"><p>During the installation of Red Hat OpenStack Platform director, director also installs a set of playbooks from the openstack-tripleo-validations package. Each playbook contains tests for certain system requirements and a set of groups that define when to run the test:</p></div>
<div class="ulist"><ul><li><p><strong>no-op</strong>: Validations that run a no-op (no operation) task to verify to workflow functions correctly. These validations run on both the undercloud and overcloud.</p></li><li><p><strong>prep</strong>: Validations that check the hardware configuration of the undercloud node. Run these validation before you run the openstack undercloud install command.</p></li><li><p><strong>openshift-on-openstack</strong>: Validations that check that the environment meets the requirements to be able to deploy OpenShift on OpenStack.</p></li><li><p><strong>pre-introspection</strong>: Validations to run before the nodes introspection using Ironic Inspector.</p></li><li><p><strong>pre-deployment</strong>: Validations to run before the openstack overcloud deploy command.</p></li><li><p><strong>post-deployment</strong>: Validations to run after the overcloud deployment has finished.</p></li><li><p><strong>pre-upgrade</strong>: Validations to validate your OpenStack deployment before an upgrade.</p></li><li><p><strong>post-upgrade</strong>: Validations to validate your OpenStack deployment after an upgrade.</p><div class="olist arabic"><ol class="arabic"><li><p>Listing validations</p></li></ol></div></li></ul></div>
<div class="listingblock"><div class="content"><pre>(overcloud_test) [stack@undercloud ~]$ source ~/stackrc
(undercloud) [stack@undercloud ~]$ openstack tripleo validator list</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">+-------------------------------------+--------------------------------------------------------------------------+------------------------------------------------------------------------------+
| ID                                  | Name                                                                     | Groups                                                                       |
+-------------------------------------+--------------------------------------------------------------------------+------------------------------------------------------------------------------+
| 512e                                | Advanced Format 512e Support                                             | ['prep', 'pre-deployment']                                                   |
| validate-selinux                    | validate-selinux                                                         | ['pre-deployment', 'post-deployment', 'pre-upgrade', 'post-upgrade']         |
| ceilometerdb-size                   | Events Database Size Check (DEPRECATED)                                  | ['pre-deployment']                                                           |
| ceph-ansible-installed              | Check if ceph-ansible is installed on the undercloud                     | ['pre-deployment', 'pre-ceph']                                               |
| tls-everywhere-post-deployment      | Confirm that overcloud nodes are setup correctly                         | ['post-deployment']                                                          |
| ceph-dependencies-installed         | Check if Ceph dependencies are installed                                 | ['pre-deployment', 'pre-ceph']                                               |
| ceph-health                         | Check the status of the ceph cluster                                     | ['post-deployment', 'post-ceph']                                             |
| ceph-pg                             | Validate requested Ceph Placement Groups                                 | ['pre-deployment', 'post-ceph']                                              |
| check-ftype                         | XFS ftype check                                                          | ['pre-upgrade']                                                              |
| tls-everywhere-pre-deployment       | Confirm undercloud is setup correctly prior to overcloud deploy          | ['pre-deployment']                                                           |
| check-latest-packages-version       | Check if latest version of packages is installed                         | ['pre-upgrade']                                                              |
| check-network-gateway               | Check network_gateway on the provisioning network                        | ['pre-introspection']                                                        |
| stonith-exists                      | Validate stonith devices                                                 | ['post-deployment']                                                          |
| collect-flavors-and-verify-profiles | Collect and verify role flavors                                          | ['pre-deployment', 'pre-upgrade']                                            |
| container-status                    | Ensure container status                                                  | ['pre-upgrade', 'post-deployment', 'post-upgrade']                           |
| switch-vlans                        | Compare switch port VLANs to VLANs in nic config                         | ['pre-deployment']                                                           |
| containerized-undercloud-docker     | Verify docker containers are up and ports are open                       | ['post-deployment', 'pre-upgrade']                                           |
| controller-token                    | Verify that keystone admin token is disabled                             | ['post-deployment']                                                          |
| controller-ulimits                  | Check controller ulimits                                                 | ['post-deployment']                                                          |
| ctlplane-ip-range                   | Check the number of IP addresses available for the overcloud nodes       | ['pre-introspection']                                                        |
| default-node-count                  | Verify hypervisor statistics                                             | ['pre-deployment']                                                           |
| dhcp-introspection                  | DHCP on the Introspection Network                                        | ['pre-introspection']                                                        |
| dhcp-provisioning                   | DHCP on the Provisioning Network                                         | ['pre-deployment']                                                           |
| dns                                 | Verify DNS                                                               | ['pre-deployment']                                                           |
| haproxy                             | HAProxy configuration                                                    | ['post-deployment']                                                          |
| tls-everywhere-prep                 | Confirm that undercloud is setup to register to IdM                      | ['prep']                                                                     |
| healthcheck-service-status          | Healthcheck systemd services Check                                       | ['post-deployment']                                                          |
| image-serve                         | Verify image-serve service is working and answering                      | ['pre-upgrade', 'post-deployment', 'post-upgrade']                           |
| undercloud-cpu                      | Verify undercloud fits the CPU core requirements                         | ['prep', 'pre-introspection']                                                |
| ironic-boot-configuration           | Check Ironic boot configuration                                          | ['pre-deployment', 'pre-upgrade']                                            |
| mysql-open-files-limit              | MySQL Open Files Limit                                                   | ['post-deployment']                                                          |
| network-environment                 | Validate the Heat environment file for network configuration             | ['pre-deployment']                                                           |
| neutron-sanity-check                | Neutron Sanity Check                                                     | ['post-deployment']                                                          |
| undercloud-ram                      | Verify the undercloud fits the RAM requirements                          | ['prep', 'pre-introspection', 'pre-upgrade']                                 |
| no-op-firewall-nova-driver          | Verify NoOpFirewallDriver is set in Nova                                 | ['post-deployment']                                                          |
| no-op                               | NO-OP validation                                                         | ['no-op']                                                                    |
| node-disks                          | Check node disk configuration                                            | ['pre-deployment']                                                           |
| node-health                         | Node health check                                                        | ['pre-upgrade']                                                              |
| nova-event-callback                 | Nova Event Callback Configuration Check                                  | ['post-deployment']                                                          |
| nova-status                         | Nova Status Upgrade Check                                                | ['pre-upgrade']                                                              |
| ntp                                 | Verify all deployed nodes have their clock synchronised                  | ['post-deployment']                                                          |
| undercloud-debug                    | Undercloud Services Debug Check                                          | ['pre-deployment']                                                           |
| openshift-hw-requirements           | Check resources for an OpenShift on OpenStack deployment                 | ['openshift-on-openstack']                                                   |
| undercloud-selinux-mode             | Undercloud SELinux Enforcing Mode Check                                  | ['prep', 'pre-introspection']                                                |
| openshift-nw-requirements           | Check network requirements for an OpenShift on OpenStack deployment      | ['openshift-on-openstack']                                                   |
| openstack-endpoints                 | Check connectivity to various OpenStack services                         | ['post-deployment', 'pre-upgrade', 'post-upgrade']                           |
| undercloud-service-status           | Verify undercloud services state before running update or upgrade        | ['post-upgrade', 'pre-upgrade']                                              |
| ovs-dpdk-pmd-cpus-check             | Validates OVS DPDK PMD cores from all NUMA nodes.                        | ['post-deployment']                                                          |
| pacemaker-status                    | Check the status of the pacemaker cluster                                | ['post-deployment']                                                          |
| rabbitmq-limits                     | Rabbitmq limits                                                          | ['post-deployment']                                                          |
| repos                               | Check correctness of current repositories                                | ['pre-upgrade']                                                              |
| service-status                      | Ensure services state                                                    | ['prep', 'pre-deployment', 'pre-upgrade', 'post-deployment', 'post-upgrade'] |
| stack-health                        | Stack Health Check                                                       | ['pre-upgrade', 'post-upgrade']                                              |
| undercloud-disk-space-pre-upgrade   | Verify undercloud fits the disk space requirements to perform an upgrade | ['pre-upgrade']                                                              |
| undercloud-disk-space               | Verify undercloud fits the disk space requirements                       | ['prep', 'pre-introspection']                                                |
| undercloud-tokenflush               | Verify token_flush is enabled in keystone users crontab                  | ['pre-introspection']                                                        |
| undercloud-heat-purge-deleted       | Verify heat-manage purge_deleted is enabled in crontab                   | ['pre-upgrade', 'pre-deployment']                                            |
| undercloud-process-count            | Check the number of OpenStack processes on undercloud                    | ['pre-deployment']                                                           |
| undercloud-neutron-sanity-check     | Undercloud Neutron Sanity Check                                          | ['pre-introspection']                                                        |
+-------------------------------------+--------------------------------------------------------------------------+------------------------------------------------------------------------------+</pre></div></div>
<div class="olist arabic"><ol class="arabic"><li><p>Run one of the validations</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ openstack tripleo validator run --validation controller-ulimits</pre></div></div></li></ol></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">[SUCCESS] - controller-ulimits.yaml
    b'Using /tmp/controller-ulimits.yamlwcb85wavansible.cfg as config file'
    b'Success! The validation passed for all hosts:'
    b'* lab-controller01'
    b'* lab-controller02'
    b'* lab-controller03'</pre></div></div></div>
<div class="sect2"><h3 id="_fencing_validation">Fencing validation</h3><div class="paragraph"><p>Fencing is the process of isolating a failed node to protect a cluster and its resources. Without fencing, a failed node can result in data corruption in a cluster.</p></div>
<div class="paragraph"><p>The director uses Pacemaker to provide a highly available cluster of Controller nodes. Pacemaker uses a process called STONITH to fence failed nodes. STONITH is disabled by default and requires manual configuration so that Pacemaker can control the power management of each node in the cluster.</p></div>
<div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ openstack tripleo validator run --validation stonith-exists</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">[FAILED] - stonith-exists.yaml
    b'Using /tmp/stonith-exists.yamlvf9l9drzansible.cfg as config file'
    b"Task 'stonith_exists : Verify the stonith device are configured' failed:"
    b'Host: lab-controller01'
    b'Message: Stonith devices are not configured.'
    b"Task 'stonith_exists : Verify the stonith device are configured' failed:"
    b'Host: lab-controller02'
    b'Message: Stonith devices are not configured.'
    b"Task 'stonith_exists : Verify the stonith device are configured' failed:"
    b'Host: lab-controller03'
    b'Message: Stonith devices are not configured.'
    b'Failure! The validation failed for all hosts:'
    b'* lab-controller01'
    b'* lab-controller02'
    b'* lab-controller03'

One or more validations have failed!</pre></div></div></div>
<div class="sect2"><h3 id="_fix_the_fencing_validation">Fix the fencing validation</h3><div class="olist arabic"><ol class="arabic"><li><p>Check the fencing status:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ ssh heat-admin@lab-controller01.ctlplane sudo pcs property show
Cluster Properties:
 OVN_REPL_INFO: lab-controller01
 cluster-infrastructure: corosync
 cluster-name: tripleo_cluster
 dc-version: 2.0.2-3.el8_1.2-744a30d655
 have-watchdog: false
 redis_REPL_INFO: lab-controller01
 stonith-enabled: false</pre></div></div></li><li><p>Generate a <code>fencing.yaml</code> file using the following command:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ openstack overcloud generate fencing --ipmi-lanplus --ipmi-level administrator --output ~/templates/fencing.yaml nodes.json</pre></div></div>
<div class="ulist"><ul><li><p>This command doesn&#8217;t show any output.</p></li></ul></div></li><li><p>Check the content of the file:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ head -20 ~/templates/fencing.yaml</pre></div></div>
<div class="listingblock"><div class="title">Sample Content</div><div class="content"><pre class="nowrap">parameter_defaults:
  EnableFencing: true
  FencingConfig:
    devices:
    - agent: fence_ipmilan
      host_mac: 52:54:00:0c:81:9b
      params:
        ipaddr: 192.168.1.1
        ipport: '6235'
        lanplus: true
        login: admin
        passwd: password
        pcmk_host_list: lab-compute01
        privlvl: administrator
    - agent: fence_ipmilan
      host_mac: 52:54:00:cf:48:df
      params:
        ipaddr: 192.168.1.1
        ipport: '6231'
        lanplus: true</pre></div></div>
<div class="admonitionblock note"><table><tr><td class="icon"><i class="icon-note" title="Note"></i></td><td class="content">All nodes are specified on the file, but only controllers are going to be used.</td></tr></table></div></li><li><p>Update the deploy script adding <code>-e $CNF/fencing.yaml</code> to the <code>deploy-with-ext-ceph-stf.sh</code>:</p><div class="listingblock"><div class="content"><pre class="nowrap">#!/bin/bash
THT=/usr/share/openstack-tripleo-heat-templates/
CNF=~/templates/

source ~/stackrc
openstack overcloud deploy --templates $THT \
-r $CNF/roles_data.yaml \
-n $CNF/network_data.yaml \
-e $THT/environments/network-isolation.yaml \
-e $THT/environments/ceph-ansible/ceph-ansible-external.yaml \
-e $THT/environments/metrics/ceilometer-write-qdr.yaml \
-e $THT/environments/enable-stf.yaml \
-e $THT/environments/ips-from-pool-all.yaml \
-e $CNF/environments/network-environment.yaml \
-e $CNF/environments/net-bond-with-vlans.yaml \
-e ~/containers-prepare-parameter.yaml \
-e $CNF/node-info.yaml \
-e $CNF/ceph-external.yaml \
-e $CNF/HostnameMap.yaml \
-e $CNF/ips-from-pool-all.yaml \
-e $CNF/stf-connectors.yaml \
-e $CNF/fencing.yaml \
-e $CNF/fix-nova-reserved-host-memory.yaml</pre></div></div></li><li><p>Run the deploy again to enable the fencing:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ ./deploy-with-ext-ceph-stf.sh</pre></div></div></li><li><p>Wait till the deployment is updated:</p><div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">Ansible passed.
Overcloud configuration completed.
Waiting for messages on queue 'tripleo' with no timeout.
Overcloud Endpoint: http://10.0.0.150:5000
Overcloud Horizon Dashboard URL: http://10.0.0.150:80/dashboard
Overcloud rc file: /home/stack/overcloudrc
Overcloud Deployed</pre></div></div></li><li><p>Run the validation script again:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ openstack tripleo validator run --validation stonith-exists</pre></div></div>
<div class="listingblock"><div class="title">Expected Output</div><div class="content"><pre class="nowrap">[SUCCESS] - stonith-exists.yaml
    b'Using /tmp/stonith-exists.yamlfvx2ctktansible.cfg as config file'
    b'Success! The validation passed for all hosts:'
    b'* lab-controller01'
    b'* lab-controller02'
    b'* lab-controller03'</pre></div></div></li><li><p>Check the pacemaker status:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ ssh heat-admin@lab-controller01.ctlplane "sudo pcs property show"</pre></div></div>
<div class="listingblock"><div class="title">Expected Output</div><div class="content"><pre class="nowrap">Cluster Properties:
 OVN_REPL_INFO: lab-controller01
 cluster-infrastructure: corosync
 cluster-name: tripleo_cluster
 dc-version: 2.0.2-3.el8_1.2-744a30d655
 have-watchdog: false
 redis_REPL_INFO: lab-controller01
 stonith-enabled: true</pre></div></div></li><li><p>Check the resources:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ ssh heat-admin@lab-controller01.ctlplane "sudo pcs status | grep fence"</pre></div></div>
<div class="listingblock"><div class="title">Excerpt</div><div class="content"><pre class="nowrap"> stonith-fence_ipmilan-5254005ac166	(stonith:fence_ipmilan):	Started lab-controller02
 stonith-fence_ipmilan-525400274cad	(stonith:fence_ipmilan):	Started lab-controller01
 stonith-fence_ipmilan-525400cb0181	(stonith:fence_ipmilan):	Started lab-controller03
</pre></div></div></li><li><p>Simulate a system issue, rejecting the connections to one of the controllers:</p><div class="listingblock"><div class="content"><pre>(undercloud) [stack@undercloud ~]$ ssh heat-admin@lab-controller01.ctlplane</pre></div></div>
<div class="listingblock"><div class="title">[lab-controller01]</div><div class="content"><pre>
[heat-admin@lab-controller01 ~]$ sudo -i
[root@lab-controller01 ~]# iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT &amp;&amp;
 iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT &amp;&amp;
 iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 5016 -j ACCEPT &amp;&amp;
 iptables -A INPUT -p udp -m state --state NEW -m udp --dport 5016 -j ACCEPT &amp;&amp;
 iptables -A INPUT ! -i lo -j REJECT --reject-with icmp-host-prohibited &amp;&amp;
 iptables -A OUTPUT -p tcp --sport 22 -j ACCEPT &amp;&amp;
 iptables -A OUTPUT -p tcp --sport 5016 -j ACCEPT &amp;&amp;
 iptables -A OUTPUT -p udp --sport 5016 -j ACCEPT &amp;&amp;
 iptables -A OUTPUT ! -o lo -j REJECT --reject-with icmp-host-prohibited</pre></div></div>
<div class="admonitionblock important"><table><tr><td class="icon"><i class="icon-important" title="Important"></i></td><td class="content">System will be rebooted automatically, due to lost of connection from other servers.</td></tr></table></div></li><li><p>Connect to another controller and check the fencing logs:</p><div class="listingblock"><div class="content"><pre>(undercloud) [stack@undercloud ~]$ ssh heat-admin@lab-controller02.ctlplane</pre></div></div>
<div class="listingblock"><div class="title">[lab-controller02]</div><div class="content"><pre>[heat-admin@lab-controller02 ~]$ sudo grep fencing /var/log/pacemaker/pacemaker.log |grep -v "is active"</pre></div></div>
<div class="listingblock"><div class="title">Sample Output</div><div class="content"><pre class="nowrap">Dec 10 17:40:33 [22971] lab-controller02    pengine:     info: fence_guest:	Implying guest node rabbitmq-bundle-0 is down (action 198) after lab-controller01 fencing
Dec 10 17:40:33 [22971] lab-controller02    pengine:     info: fence_guest:	Implying guest node redis-bundle-0 is down (action 203) after lab-controller01 fencing
Dec 10 17:40:37 [22972] lab-controller02       crmd:   notice: te_fence_node:	Requesting fencing (reboot) of node lab-controller01 | action=1 timeout=60000
Dec 10 17:40:37 [22968] lab-controller02 stonith-ng:   notice: initiate_remote_stonith_op:	Requesting peer fencing (reboot) of lab-controller01 | id=5affda84-acba-4488-8684-27f3b9f8b904 state=0
Dec 10 17:40:37 [22968] lab-controller02 stonith-ng:     info: call_remote_stonith:	Total timeout set to 60 for peer's fencing of lab-controller01 for crmd.22972|id=5affda84-acba-4488-8684-27f3b9f8b904
Dec 10 17:40:43 [22972] lab-controller02       crmd:     info: cib_fencing_updated:	Fencing update 22204 for lab-controller01: complete
Dec 10 17:40:43 [22972] lab-controller02       crmd:     info: cib_fencing_updated:	Fencing update 22207 for lab-controller01: complete</pre></div></div></li></ol></div></div>
<div class="sect2"><h3 id="_fix_the_failed_configuration_validation_only_as_an_example_strong_do_not_run_strong">Fix the failed configuration validation (ONLY AS AN EXAMPLE, <strong>DO NOT RUN</strong>)</h3><div class="paragraph"><p>Fixing failed validations in the overcloud usually entails an installation update to re-configure the corresponding values in a reproducible way.</p></div>
<div class="paragraph"><p>In this example we create a validation script to address the <code>nofile</code> limit.</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Create the <code>controller-pre.yaml</code> template file:</p><div class="listingblock"><div class="content"><pre class="nowrap">(undercloud) [stack@undercloud ~]$ cat &gt; ~/templates/controller-pre.yaml &lt;&lt;EOF
heat_template_version: 2015-04-30

parameters:
  server:
    type: string

resources:
  LimitConfig:
    type: OS::Heat::SoftwareConfig
    properties:
      group: script
      config: |
        #!/bin/bash
        set -eux
        set -o pipefail
        cat &gt; /etc/security/limits.d/20-nofile.conf &lt;&lt;EOF
        *   soft   nofile   2048
        EOF
  LimitDeployment:
    type: OS::Heat::SoftwareDeployment
    properties:
      config: {get_resource: LimitConfig}
      server: {get_param: server}

outputs:
  deploy_stdout:
    description: Deployment stdout
    value: {get_attr: [LimitDeployment, deploy_stdout]}
EOF</pre></div></div></li><li><p>Create the <code>limits.yaml</code> environment file linking <code>controller-pre.yaml</code> to the pre-deployment hook:</p><div class="listingblock"><div class="content"><pre class="nowrap">$ cat &gt; ~/templates/limits.yaml &lt;&lt;EOF
resource_registry:
  OS::TripleO::ControllerExtraConfigPre: /home/stack/templates/controller-pre.yaml
EOF</pre></div></div></li><li><p>Append the <code>limits.yaml</code> environment file to the end of the deployment script:</p></li></ol></div></div></div></div>
<div class="sect1"><h2 id="_outcome_of_this_lab">Outcome of This Lab</h2><div class="sectionbody"><div class="paragraph"><p>By completing this lab you should have achieved the following objectives:</p></div>
<div class="ulist"><ul><li><p>Create dedicated network configuration templates for bonding and network isolation</p></li><li><p>Deploy Ceph storage for our overcloud infrastructure</p></li><li><p>Make configuration-specific changes to the overcloud to match example requirements</p></li><li><p>Check Fernet keys</p></li><li><p>Check STF</p></li><li><p>Detect and correct configuration settings that could potentially cause problems using the validations framework.</p></li></ul></div></div></div></div><div id="footer"><div id="footer-text"><br>Build Version: 1.6.7   :   Last updated 2020-09-20 04:59:02 EDT</div></div></body></html>